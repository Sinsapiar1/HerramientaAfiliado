// ===== AVATAR SYNC SYSTEM v1.0 =====
// Sistema de sincronizaci√≥n autom√°tica Avatar + Contenido + Producto

console.log('üöÄ Cargando Avatar Sync System v1.0...');

const AvatarSyncSystem = {
    
    // ===== 1. AUTO-GENERADOR DE AVATAR ESPEC√çFICO POR PRODUCTO =====
    
    async generarAvatarEspecifico(contextoProducto, tiposContenido) {
        console.log('üéØ Generando avatar espec√≠fico para:', contextoProducto.nombre);
        
        if (!AppState.apiKey) {
            console.log('‚ö†Ô∏è No hay API Key, usando avatar gen√©rico');
            return this.crearAvatarGenerico(contextoProducto);
        }
        
        const prompt = this.crearPromptAvatarEspecifico(contextoProducto, tiposContenido);
        
        try {
            const respuestaIA = await APIManager.callGemini(prompt);
            const avatarProcesado = this.procesarRespuestaAvatar(respuestaIA, contextoProducto);
            
            console.log('‚úÖ Avatar espec√≠fico generado:', avatarProcesado.nombre);
            return avatarProcesado;
            
        } catch (error) {
            console.error('Error generando avatar espec√≠fico:', error);
            return this.crearAvatarGenerico(contextoProducto);
        }
    },
    
    // Crear prompt ultra-espec√≠fico para el avatar
    crearPromptAvatarEspecifico(contextoProducto, tiposContenido) {
        const painPoint = contextoProducto.painPoints[0] || 'este problema';
        const emocion = contextoProducto.emociones[0] || 'frustraci√≥n';
        const precio = contextoProducto.precio;
        const nicho = contextoProducto.nicho;
        
        return `Act√∫a como EXPERTO EN BUYER PERSONAS con 15+ a√±os creando avatares ultra-espec√≠ficos para marketing de afiliados.

üéØ MISI√ìN: Crear un AVATAR ESPEC√çFICO para quien comprar√≠a "${contextoProducto.nombre}" a ${precio}.

üìä CONTEXTO DEL PRODUCTO:
- Producto: ${contextoProducto.nombre}
- Precio: ${precio}
- Nicho: ${nicho}
- Pain Point Principal: ${painPoint}
- Emoci√≥n Target: ${emocion}
- Tipos de contenido: ${tiposContenido.join(', ')}

üß† CREAR AVATAR ULTRA-ESPEC√çFICO:

=== PERFIL DEMOGR√ÅFICO ===
NOMBRE: [Nombre t√≠pico del nicho]
EDAD: [Rango espec√≠fico para ${precio}]
OCUPACI√ìN: [Trabajo que permite gastar ${precio}]
UBICACI√ìN: [Ciudad/regi√≥n espec√≠fica]
INGRESOS: [Rango que justifica ${precio}]
FAMILIA: [Situaci√≥n que genera ${painPoint}]

=== PSICOLOG√çA PROFUNDA ===
PROBLEMA PRINCIPAL: ${painPoint} [¬øPor qu√© espec√≠ficamente?]
FRUSTRACI√ìN DIARIA: [C√≥mo ${painPoint} afecta su d√≠a a d√≠a]
MIEDO SECRETO: [Qu√© teme que pase si no resuelve ${painPoint}]
DESEO PROFUNDO: [Qu√© realmente quiere lograr con ${contextoProducto.nombre}]
EMOCI√ìN DOMINANTE: ${emocion} [¬øCu√°ndo la siente m√°s fuerte?]

=== COMPORTAMIENTO DIGITAL ===
PLATAFORMAS ACTIVAS: [Espec√≠ficas para ${nicho}]
HORARIOS ONLINE: [Cu√°ndo consume contenido sobre ${nicho}]
CONTENIDO QUE BUSCA: [Qu√© tipo de posts/videos ve sobre ${painPoint}]
INFLUENCERS QUE SIGUE: [Tipos espec√≠ficos del ${nicho}]
HASHTAGS QUE USA: [Relacionados con ${painPoint}]

=== PROCESO DE COMPRA ESPEC√çFICO ===
MOMENTO GATILLO: [Cu√°ndo decide buscar soluci√≥n para ${painPoint}]
PRIMERA REACCI√ìN: [Qu√© piensa al ver ${contextoProducto.nombre}]
OBJECI√ìN PRINCIPAL: [Por qu√© dudar√≠a de gastar ${precio}]
PRUEBA SOCIAL NECESARIA: [Qu√© evidencia necesita para ${nicho}]
URGENCIA QUE FUNCIONA: [Qu√© tipo de presi√≥n temporal responde]

=== PERSONALIDAD Y VALORES ===
PERSONALIDAD: [3 rasgos espec√≠ficos del ${nicho}]
VALORES PRINCIPALES: [Qu√© m√°s valora en la vida]
ESTILO DE COMUNICACI√ìN: [Formal/informal/t√©cnico/emocional]
LENGUAJE QUE USA: [Jerga espec√≠fica del ${nicho}]
PALABRAS QUE LO MOTIVAN: [T√©rminos que generan acci√≥n]
PALABRAS QUE LO ALEJAN: [T√©rminos que evitar en ${nicho}]

=== CONTEXTO DE ${contextoProducto.nombre} ===
POR QU√â NECESITA ESTO: [Raz√≥n espec√≠fica para ${contextoProducto.nombre}]
QU√â HA INTENTADO ANTES: [Soluciones previas fallidas para ${painPoint}]
EXPECTATIVA REALISTA: [Qu√© espera lograr con ${precio} invertido]
TIEMPO DISPONIBLE: [Cu√°nto tiempo puede dedicar al ${nicho}]
NIVEL DE COMPROMISO: [Qu√© tan serio est√° sobre resolver ${painPoint}]

üéØ RESULTADO: Avatar TAN espec√≠fico que cualquier contenido viral para ${contextoProducto.nombre} le hable directamente y convierta 5x m√°s.

IMPORTANTE:
- Ser s√∫per espec√≠fico con detalles del ${nicho}
- Conectar directamente con ${painPoint}
- Justificar por qu√© pagar√≠a ${precio}
- Hacer que sea el cliente IDEAL para ${contextoProducto.nombre}`;
    },
    
    // Procesar respuesta de IA y estructurar avatar
    procesarRespuestaAvatar(respuestaIA, contextoProducto) {
        // Extraer campos espec√≠ficos
        const extractField = (fieldName, text) => {
            const regex = new RegExp(`${fieldName}:?\\s*([^\\n]+)`, 'i');
            const match = text.match(regex);
            return match ? match[1].trim() : `Informaci√≥n sobre ${fieldName}`;
        };
        
        const extractSection = (sectionName, text) => {
            const regex = new RegExp(`=== ${sectionName} ===([\\s\\S]*?)(?:===|$)`, 'i');
            const match = text.match(regex);
            return match ? match[1].trim() : `Informaci√≥n de ${sectionName}`;
        };
        
        return {
            // Datos b√°sicos
            nombre: extractField('NOMBRE', respuestaIA),
            edad: extractField('EDAD', respuestaIA),
            ocupacion: extractField('OCUPACI√ìN', respuestaIA),
            ubicacion: extractField('UBICACI√ìN', respuestaIA),
            ingresos: extractField('INGRESOS', respuestaIA),
            familia: extractField('FAMILIA', respuestaIA),
            
            // Psicolog√≠a
            problemaPrincipal: extractField('PROBLEMA PRINCIPAL', respuestaIA),
            frustracionDiaria: extractField('FRUSTRACI√ìN DIARIA', respuestaIA),
            miedoSecreto: extractField('MIEDO SECRETO', respuestaIA),
            deseoProfundo: extractField('DESEO PROFUNDO', respuestaIA),
            emocionDominante: extractField('EMOCI√ìN DOMINANTE', respuestaIA),
            
            // Comportamiento digital
            plataformasActivas: extractField('PLATAFORMAS ACTIVAS', respuestaIA),
            horariosOnline: extractField('HORARIOS ONLINE', respuestaIA),
            contenidoQueBusca: extractField('CONTENIDO QUE BUSCA', respuestaIA),
            influencersQueSigue: extractField('INFLUENCERS QUE SIGUE', respuestaIA),
            hashtagsQueUsa: extractField('HASHTAGS QUE USA', respuestaIA),
            
            // Proceso de compra
            momentoGatillo: extractField('MOMENTO GATILLO', respuestaIA),
            primeraReaccion: extractField('PRIMERA REACCI√ìN', respuestaIA),
            objecionPrincipal: extractField('OBJECI√ìN PRINCIPAL', respuestaIA),
            pruebaSocialNecesaria: extractField('PRUEBA SOCIAL NECESARIA', respuestaIA),
            urgenciaQueFunciona: extractField('URGENCIA QUE FUNCIONA', respuestaIA),
            
            // Personalidad
            personalidad: extractField('PERSONALIDAD', respuestaIA),
            valoresPrincipales: extractField('VALORES PRINCIPALES', respuestaIA),
            estiloComunicacion: extractField('ESTILO DE COMUNICACI√ìN', respuestaIA),
            lenguajeQueUsa: extractField('LENGUAJE QUE USA', respuestaIA),
            palabrasQueMotivan: extractField('PALABRAS QUE LO MOTIVAN', respuestaIA),
            palabrasQueAlejan: extractField('PALABRAS QUE LO ALEJAN', respuestaIA),
            
            // Contexto espec√≠fico del producto
            porQueNecesitaEsto: extractField('POR QU√â NECESITA ESTO', respuestaIA),
            queHaIntentadoAntes: extractField('QU√â HA INTENTADO ANTES', respuestaIA),
            expectativaRealista: extractField('EXPECTATIVA REALISTA', respuestaIA),
            tiempoDisponible: extractField('TIEMPO DISPONIBLE', respuestaIA),
            nivelCompromiso: extractField('NIVEL DE COMPROMISO', respuestaIA),
            
            // Metadatos
            productoVinculado: contextoProducto.nombre,
            precio: contextoProducto.precio,
            nicho: contextoProducto.nicho,
            painPointPrincipal: contextoProducto.painPoints[0],
            respuestaCompleta: respuestaIA,
            timestamp: new Date().toISOString(),
            tipo: 'avatar-sincrono-especifico'
        };
    },
    
    // Crear avatar gen√©rico como fallback
    crearAvatarGenerico(contextoProducto) {
        const nicho = contextoProducto.nicho.toLowerCase();
        let avatarBase = {};
        
        if (nicho.includes('fitness') || nicho.includes('salud')) {
            avatarBase = {
                nombre: 'Ana Mart√≠nez',
                edad: '28-35 a√±os',
                ocupacion: 'Profesional de oficina',
                ubicacion: 'Ciudad principal, Espa√±a/M√©xico',
                problemaPrincipal: contextoProducto.painPoints[0] || 'Falta de tiempo para ejercicio',
                emocionDominante: contextoProducto.emociones[0] || 'Frustraci√≥n por no verse bien'
            };
        } else if (nicho.includes('dinero') || nicho.includes('negocio')) {
            avatarBase = {
                nombre: 'Carlos Rivera',
                edad: '30-40 a√±os',
                ocupacion: 'Empleado buscando ingresos extra',
                ubicacion: '√Årea metropolitana',
                problemaPrincipal: contextoProducto.painPoints[0] || 'Falta de dinero extra',
                emocionDominante: contextoProducto.emociones[0] || 'Ansiedad financiera'
            };
        } else {
            avatarBase = {
                nombre: 'Usuario Tipo',
                edad: '25-40 a√±os',
                ocupacion: 'Profesional',
                ubicacion: 'Zona urbana',
                problemaPrincipal: contextoProducto.painPoints[0] || 'Necesita soluci√≥n espec√≠fica',
                emocionDominante: contextoProducto.emociones[0] || 'B√∫squeda de mejora'
            };
        }
        
        return {
            ...avatarBase,
            productoVinculado: contextoProducto.nombre,
            precio: contextoProducto.precio,
            nicho: contextoProducto.nicho,
            painPointPrincipal: contextoProducto.painPoints[0],
            timestamp: new Date().toISOString(),
            tipo: 'avatar-sincrono-generico'
        };
    },
    
    // ===== 2. EXPORTACI√ìN COHERENTE Y SINCRONIZADA =====
    
    exportarConjuntoCoherente(contenidoViral, avatarEspecifico, contextoProducto) {
        console.log('üèóÔ∏è Exportando conjunto coherente a Funnel Architect...');
        
        const conjuntoCoherente = {
            // Informaci√≥n base
            timestamp: new Date().toISOString(),
            tipo: 'conjunto-coherente-v1',
            version: '1.0',
            
            // Producto central
            producto: {
                nombre: contextoProducto.nombre,
                precio: contextoProducto.precio,
                comision: contextoProducto.comision,
                nicho: contextoProducto.nicho,
                painPoints: contextoProducto.painPoints,
                emociones: contextoProducto.emociones,
                triggers: contextoProducto.triggers,
                descripcion: contextoProducto.descripcion
            },
            
            // Avatar espec√≠fico generado
            avatar: {
                ...avatarEspecifico,
                vinculacion: 'especifico-para-producto',
                congruencia: 'alta'
            },
            
            // Contenido viral generado
            contenido: {
                respuesta: contenidoViral.respuesta,
                tipos: contenidoViral.tipos,
                timestamp: contenidoViral.timestamp,
                vinculacion: 'especifico-para-producto'
            },
            
            // Metadatos de coherencia
            coherencia: {
                nivel: 'ultra-especifica',
                verificaciones: {
                    productoAvatarMatch: this.verificarCoherenciaProductoAvatar(contextoProducto, avatarEspecifico),
                    avatarContenidoMatch: this.verificarCoherenciaAvatarContenido(avatarEspecifico, contenidoViral),
                    productoContenidoMatch: this.verificarCoherenciaProductoContenido(contextoProducto, contenidoViral)
                }
            },
            
            // Instrucciones de uso
            instrucciones: {
                funnel: `Usar avatar "${avatarEspecifico.nombre}" para producto "${contextoProducto.nombre}"`,
                targeting: `Enfocar en ${avatarEspecifico.problemaPrincipal} con emoci√≥n ${avatarEspecifico.emocionDominante}`,
                contenido: `Usar scripts generados para ${contenidoViral.tipos.join(', ')} con precio ${contextoProducto.precio}`
            }
        };
        
        // Exportar a localStorage para Funnel Architect
        localStorage.setItem('funnel_conjunto_coherente', JSON.stringify(conjuntoCoherente));
        
        // Tambi√©n mantener formato anterior para compatibilidad
        localStorage.setItem('funnel_avatars', JSON.stringify([avatarEspecifico]));
        localStorage.setItem('funnel_products', JSON.stringify([contextoProducto]));
        localStorage.setItem('funnel_contenido_viral', JSON.stringify(contenidoViral));
        
        // Datos para exportaci√≥n completa
        const datosExportacion = {
            avatares: [avatarEspecifico],
            productos: [contextoProducto],
            contenido: contenidoViral,
            conjuntoCoherente: conjuntoCoherente
        };
        
        localStorage.setItem('marketinsight_export_coherente', JSON.stringify(datosExportacion));
        
        console.log('‚úÖ Conjunto coherente exportado exitosamente');
        return conjuntoCoherente;
    },
    
    // Verificaciones de coherencia
    verificarCoherenciaProductoAvatar(producto, avatar) {
        const checks = {
            nichoMatch: avatar.nicho === producto.nicho,
            painPointMatch: avatar.painPointPrincipal === producto.painPoints[0],
            precioJustificado: avatar.precio === producto.precio,
            vinculacionCorrecta: avatar.productoVinculado === producto.nombre
        };
        
        const coherentes = Object.values(checks).filter(Boolean).length;
        const total = Object.keys(checks).length;
        
        return {
            porcentaje: Math.round((coherentes / total) * 100),
            detalles: checks,
            nivel: coherentes === total ? 'perfecta' : coherentes >= total * 0.8 ? 'alta' : 'media'
        };
    },
    
    verificarCoherenciaAvatarContenido(avatar, contenido) {
        // Verificar que el contenido mencione elementos del avatar
        const contenidoTexto = contenido.respuesta.toLowerCase();
        const checks = {
            mencionaPainPoint: contenidoTexto.includes(avatar.painPointPrincipal?.toLowerCase() || ''),
            mencionaEmocion: contenidoTexto.includes(avatar.emocionDominante?.toLowerCase() || ''),
            mencionaProducto: contenidoTexto.includes(avatar.productoVinculado?.toLowerCase() || ''),
            timestampCercano: Math.abs(new Date(avatar.timestamp) - new Date(contenido.timestamp)) < 60000 // 1 minuto
        };
        
        const coherentes = Object.values(checks).filter(Boolean).length;
        const total = Object.keys(checks).length;
        
        return {
            porcentaje: Math.round((coherentes / total) * 100),
            detalles: checks,
            nivel: coherentes >= total * 0.8 ? 'alta' : coherentes >= total * 0.6 ? 'media' : 'baja'
        };
    },
    
    verificarCoherenciaProductoContenido(producto, contenido) {
        const contenidoTexto = contenido.respuesta.toLowerCase();
        const checks = {
            mencionaProducto: contenidoTexto.includes(producto.nombre.toLowerCase()),
            mencionaPrecio: contenidoTexto.includes(producto.precio),
            mencionaComision: contenidoTexto.includes(producto.comision),
            mencionaPainPoint: contenidoTexto.includes(producto.painPoints[0]?.toLowerCase() || '')
        };
        
        const coherentes = Object.values(checks).filter(Boolean).length;
        const total = Object.keys(checks).length;
        
        return {
            porcentaje: Math.round((coherentes / total) * 100),
            detalles: checks,
            nivel: coherentes >= total * 0.8 ? 'alta' : coherentes >= total * 0.6 ? 'media' : 'baja'
        };
    }
};

// ===== 3. INICIALIZACI√ìN Y EXPORTACI√ìN =====

console.log('‚úÖ Avatar Sync System v1.0 cargado correctamente');

// Auto-ejecutar cuando est√© listo el DOM
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üéØ Avatar Sync System listo para sincronizaci√≥n autom√°tica');
    });
} else {
    console.log('üéØ Avatar Sync System listo para sincronizaci√≥n autom√°tica');
}

// Exportar para uso global
window.AvatarSyncSystem = AvatarSyncSystem;