<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketInsight Pro AFFILIATE EDITION üöÄ</title>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8Z78E3JBG3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8Z78E3JBG3');
</script>
  <script type="module" crossorigin src="/HerramientaAfiliado/assets/index-Cz98SSun.js"></script>
  <link rel="stylesheet" crossorigin href="/HerramientaAfiliado/assets/index-VPPR86zM.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-main">
                <h1>üí∞ MarketInsight Pro AFFILIATE EDITION</h1>
                <div class="subtitle">Detecta Productos Ganadores para Marketing de Afiliados</div>
            </div>
            <div class="header-controls">
                <!-- Toggle Modo Oscuro/Claro -->
                <div class="theme-toggle">
                    <button class="theme-btn" id="themeToggle" title="Cambiar tema">
                        <span class="theme-icon light-icon">‚òÄÔ∏è</span>
                        <span class="theme-icon dark-icon">üåô</span>
                    </button>
                </div>
            </div>
            <div class="features">
                <span class="feature-badge">üéØ Productos Ganadores</span>
                <span class="feature-badge">üíµ An√°lisis de Comisiones</span>
                <span class="feature-badge">üìä Competencia</span>
                <span class="feature-badge">üî• Tendencias</span>
                <span class="feature-badge">üöÄ ROI Estimado</span>
                <span class="feature-badge">üîç Keywords</span>
            </div>
        </div>

        <div class="main-content">
            <!-- API Configuration -->
            <div class="api-section">
                <h3>üîë Configuraci√≥n de Google AI Studio</h3>
                <p style="color: #a0aec0; margin-bottom: 15px;">Ingresa tu API Key de Google AI Studio:</p>
                <div class="input-group">
                    <input type="password" id="apiKey" placeholder="Tu API Key aqu√≠..." />
                    <select id="apiProvider" style="margin-left:8px;">
                      <option value="gemini">Google Gemini</option>
                      <option value="openai">OpenAI GPT-3.5</option>
                      <option value="together">Together.ai (Mistral 7B)</option>
                      <option value="cohere">Cohere (Command-R)</option>
                    </select>
                    <a id="getKeyLink" href="https://aistudio.google.com/app/apikey" target="_blank" style="margin-left:8px;font-size:0.9rem;">Obtener API Key</a>
                    <button class="btn btn-warning" id="saveBtn">üíæ Guardar</button>
                    <button class="btn btn-secondary" id="testBtn">üß™ Probar</button>
                </div>
                <div id="statusDiv"></div>
            </div>

            <!-- Main Form -->
            <div class="form-section">
                <h2>üéØ Configuraci√≥n de B√∫squeda de Productos Ganadores</h2>
                
                <!-- An√°lisis Options - Reorganizados -->
                <div class="analysis-sections">
                    <div class="analysis-group">
                        <h4>üìä An√°lisis B√°sicos</h4>
                        <div class="analysis-options basic-analysis">
                            <div class="option-card">
                                <input type="checkbox" id="analyzeCompetition" checked>
                                <label for="analyzeCompetition">üìä An√°lisis de Competencia</label>
                            </div>
                            <div class="option-card">
                                <input type="checkbox" id="analyzeTrends" checked>
                                <label for="analyzeTrends">üìà An√°lisis de Tendencias</label>
                            </div>
                            <div class="option-card">
                                <input type="checkbox" id="findAffiliates" checked>
                                <label for="findAffiliates">ü§ù Programas de Afiliados</label>
                            </div>
                            <div class="option-card">
                                <input type="checkbox" id="analyzeKeywords" checked>
                                <label for="analyzeKeywords">üîç Keywords Rentables</label>
                            </div>
                            <div class="option-card">
                                <input type="checkbox" id="analyzeSeasonality" checked>
                                <label for="analyzeSeasonality">üìÖ Estacionalidad</label>
                            </div>
                            <div class="option-card">
                                <input type="checkbox" id="analyzeProfitability" checked>
                                <label for="analyzeProfitability">üí∞ Rentabilidad</label>
                            </div>
                        </div>
                    </div>

                    <div class="analysis-group">
                        <h4>‚≠ê An√°lisis Expertos</h4>
                        <div class="analysis-options expert-analysis-group">
                            <div class="option-card expert-analysis">
                                <input type="checkbox" id="analyzeConversion" checked>
                                <label for="analyzeConversion">üéØ M√©tricas de Conversi√≥n</label>
                                <small>CVR, EPC, AOV</small>
                            </div>
                            <div class="option-card expert-analysis">
                                <input type="checkbox" id="analyzeFinancial" checked>
                                <label for="analyzeFinancial">üíé An√°lisis Financiero</label>
                                <small>ROI, CPA, Profit Margin</small>
                            </div>
                            <div class="option-card expert-analysis">
                                <input type="checkbox" id="analyzeCompetitorIntel" checked>
                                <label for="analyzeCompetitorIntel">üïµÔ∏è Inteligencia Competitiva</label>
                                <small>Ad Spend, Saturaci√≥n</small>
                            </div>
                            <div class="option-card expert-analysis">
                                <input type="checkbox" id="analyzeCustomerJourney" checked>
                                <label for="analyzeCustomerJourney">üé™ Customer Journey</label>
                                <small>Touchpoints, Objeciones</small>
                            </div>
                            <div class="option-card expert-analysis">
                                <input type="checkbox" id="analyzeTrafficChannels" checked>
                                <label for="analyzeTrafficChannels">üöÄ Canales de Tr√°fico</label>
                                <small>CPC, Volumen, Potencial</small>
                            </div>
                            <div class="option-card expert-analysis">
                                <input type="checkbox" id="analyzeFunnels" checked>
                                <label for="analyzeFunnels">üîÑ Funnels y Upsells</label>
                                <small>Cross-selling, LTV</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Basic Configuration -->
                <div class="config-section">
                    <h4>‚öôÔ∏è Configuraci√≥n B√°sica</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>üéØ Nicho de Mercado:</label>
                            <input type="text" id="nicho" placeholder="Ej: Fitness, Tecnolog√≠a, Belleza..." value="Fitness y Bienestar">
                        </div>
                        <div class="form-group">
                            <label>üë• P√∫blico Objetivo:</label>
                            <input type="text" id="publico" placeholder="Ej: Mujeres 25-35, Gamers..." value="Personas de 25-45 a√±os">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>üíµ Rango de Precio Ideal:</label>
                            <select id="rangoPrecios">
                                <option value="bajo">$10 - $50 (Impulso)</option>
                                <option value="medio" selected>$50 - $200 (Considerado)</option>
                                <option value="alto">$200 - $500 (Premium)</option>
                                <option value="muy-alto">$500+ (Lujo)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üìä Tipo de Producto:</label>
                            <select id="tipoProducto">
                                <option value="fisico">Producto F√≠sico</option>
                                <option value="digital" selected>Producto Digital</option>
                                <option value="servicio">Servicio/Suscripci√≥n</option>
                                <option value="mixto">Mixto</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>üé™ Canal Principal:</label>
                            <select id="canalPrincipal">
                                <option value="blog">Blog/SEO</option>
                                <option value="youtube">YouTube</option>
                                <option value="instagram">Instagram</option>
                                <option value="tiktok">TikTok</option>
                                <option value="email">Email Marketing</option>
                                <option value="paid" selected>Ads Pagados</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üöÄ Experiencia en Afiliados:</label>
                            <select id="experiencia">
                                <option value="principiante">Principiante</option>
                                <option value="intermedio" selected>Intermedio</option>
                                <option value="avanzado">Avanzado</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Expert Configuration -->
                <div class="expert-section">
                    <h3>üéØ Configuraci√≥n Experta de Afiliado</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>üí∞ Presupuesto Publicitario Mensual:</label>
                            <select id="presupuestoAds">
                                <option value="0">Sin presupuesto (Org√°nico)</option>
                                <option value="500">$500 - $1,000</option>
                                <option value="1000" selected>$1,000 - $3,000</option>
                                <option value="3000">$3,000 - $5,000</option>
                                <option value="5000">$5,000 - $10,000</option>
                                <option value="10000">$10,000+</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üìä Objetivo de ROI M√≠nimo:</label>
                            <select id="roiObjetivo">
                                <option value="2">200% (2x)</option>
                                <option value="3" selected>300% (3x)</option>
                                <option value="4">400% (4x)</option>
                                <option value="5">500% (5x)</option>
                                <option value="10">1000% (10x)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>‚è±Ô∏è Tolerancia de Break-Even:</label>
                            <select id="breakEvenTime">
                                <option value="inmediato">Inmediato (D√≠a 1)</option>
                                <option value="semana">1 Semana</option>
                                <option value="mes" selected>1 Mes</option>
                                <option value="trimestre">3 Meses</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üéØ Tipo de Conversi√≥n Preferida:</label>
                            <select id="tipoConversion">
                                <option value="inmediata" selected>Venta Inmediata</option>
                                <option value="lead">Lead Generation</option>
                                <option value="recurring">Suscripci√≥n Recurrente</option>
                                <option value="alto-ticket">Alto Ticket</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>üì± Dispositivo Principal del P√∫blico:</label>
                            <select id="dispositivoTarget">
                                <option value="mobile" selected>M√≥vil (70%+)</option>
                                <option value="desktop">Desktop (70%+)</option>
                                <option value="mixto">Mixto 50/50</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üåç Mercado Geogr√°fico:</label>
                            <select id="mercadoGeo">
                                <option value="latam" selected>Latinoam√©rica</option>
                                <option value="usa">Estados Unidos</option>
                                <option value="europa">Europa</option>
                                <option value="global">Global</option>
                            </select>
                        </div>
                    </div>

                <!-- AGREGAR DESPU√âS DE LA EXPERT-SECTION EN EL HTML EXISTENTE -->

                <!-- ===================== GENERADOR DE CONTENIDO VIRAL ===================== -->
                <div class="viral-content-section">
                    <h3>üéØ Generador de Contenido Viral</h3>
                    <p class="section-description">Genera contenido de alta conversi√≥n para todos tus canales de marketing</p>
                    
                    <div class="content-type-selector">
                        <div class="content-type-grid">
                            <div class="content-type-card" data-type="tiktok">
                                <div class="content-icon">üì±</div>
                                <h4>TikTok/Reels</h4>
                                <p>Scripts virales de 15-60s</p>
                            </div>
                            <div class="content-type-card" data-type="email">
                                <div class="content-icon">üìß</div>
                                <h4>Email Marketing</h4>
                                <p>Subject lines que abren</p>
                            </div>
                            <div class="content-type-card" data-type="facebook">
                                <div class="content-icon">üìä</div>
                                <h4>Facebook Ads</h4>
                                <p>Headlines ganadoras</p>
                            </div>
                            <div class="content-type-card" data-type="instagram">
                                <div class="content-icon">üì∏</div>
                                <h4>Instagram</h4>
                                <p>Posts con engagement</p>
                            </div>
                            <div class="content-type-card" data-type="blog">
                                <div class="content-icon">‚úçÔ∏è</div>
                                <h4>Blog/SEO</h4>
                                <p>Art√≠culos optimizados</p>
                            </div>
                            <div class="content-type-card" data-type="youtube">
                                <div class="content-icon">üé•</div>
                                <h4>YouTube</h4>
                                <p>T√≠tulos y thumbnails</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="content-config">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>üéØ √Ångulo de Venta Principal:</label>
                                <select id="salesAngle">
                                    <option value="problema-agitacion">Problema + Agitaci√≥n</option>
                                    <option value="antes-despues">Antes vs Despu√©s</option>
                                    <option value="secreto-revelado">Secreto Revelado</option>
                                    <option value="autoridad-social">Autoridad Social</option>
                                    <option value="escasez-urgencia">Escasez + Urgencia</option>
                                    <option value="story-telling">Story Telling</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>üò± Nivel de Controversia:</label>
                                <select id="controversyLevel">
                                    <option value="safe">Seguro (Familiar)</option>
                                    <option value="medium" selected>Medio (Llamativo)</option>
                                    <option value="high">Alto (Viral)</option>
                                    <option value="extreme">Extremo (Riesgoso)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>üî• Palabras de Poder (separadas por comas):</label>
                            <input type="text" id="powerWords" placeholder="gratis, secreto, exclusivo, limitado, revelado..." 
                                value="gratis, secreto, exclusivo, limitado, revelado, prohibido, oculto">
                        </div>
                    </div>
                    
                    <button class="btn btn-viral" id="generateContentBtn">
                        <span class="btn-icon">üöÄ</span>
                        <span class="btn-text">Generar Contenido Viral</span>
                    </button>
                </div>

                <!-- ===================== AVATAR ULTRA-ESPEC√çFICO ===================== -->
                <div class="avatar-section">
                    <h3>üß† Avatar Ultra-Espec√≠fico</h3>
                    <p class="section-description">Crea un perfil psicol√≥gico profundo de tu cliente ideal</p>
                    
                    <div class="avatar-config">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>üë§ G√©nero Principal:</label>
                                <select id="avatarGender">
                                    <option value="femenino">Femenino</option>
                                    <option value="masculino">Masculino</option>
                                    <option value="mixto" selected>Mixto</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>üéÇ Rango de Edad:</label>
                                <select id="avatarAge">
                                    <option value="18-25">18-25 (Gen Z)</option>
                                    <option value="25-35" selected>25-35 (Millennials)</option>
                                    <option value="35-45">35-45 (Gen X J√≥venes)</option>
                                    <option value="45-55">45-55 (Gen X)</option>
                                    <option value="55+">55+ (Boomers)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label>üí∞ Nivel Socioecon√≥mico:</label>
                                <select id="avatarIncome">
                                    <option value="bajo">Bajo ($20K-$40K)</option>
                                    <option value="medio" selected>Medio ($40K-$80K)</option>
                                    <option value="medio-alto">Medio-Alto ($80K-$150K)</option>
                                    <option value="alto">Alto ($150K+)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>üè† Situaci√≥n Familiar:</label>
                                <select id="avatarFamily">
                                    <option value="soltero">Soltero/a</option>
                                    <option value="pareja">En pareja sin hijos</option>
                                    <option value="familia" selected>Familia con hijos</option>
                                    <option value="divorciado">Divorciado/a</option>
                                    <option value="viudo">Viudo/a</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>üéØ Principal Frustraci√≥n/Problema:</label>
                            <textarea id="avatarMainProblem" rows="2" 
                                    placeholder="Ej: No tiene tiempo para hacer ejercicio por el trabajo y los ni√±os..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>üåü M√°ximo Deseo/Aspiraci√≥n:</label>
                            <textarea id="avatarMainDesire" rows="2" 
                                    placeholder="Ej: Verse y sentirse como antes del embarazo, tener energ√≠a para jugar con sus hijos..."></textarea>
                        </div>
                    </div>
                    
                    <button class="btn btn-avatar" id="generateAvatarBtn">
                        <span class="btn-icon">üß†</span>
                        <span class="btn-text">Crear Avatar Completo</span>
                    </button>
                </div>

                <!-- ===================== RESULTADOS DE CONTENIDO Y AVATAR ===================== -->
                <div id="contentResults" class="content-results hidden">
                    <h2>üéØ Contenido Viral Generado</h2>
                    <div id="contentTabs" class="content-tabs">
                        <!-- Tabs din√°micos se generan aqu√≠ -->
                    </div>
                    <div id="contentDisplay" class="content-display">
                        <!-- Contenido din√°mico se muestra aqu√≠ -->
                    </div>
                    
                    <div class="content-actions">
                        <button class="btn btn-secondary" id="copyContentBtn">üìã Copiar Todo</button>
                        <button class="btn btn-secondary" id="downloadContentBtn">üìÑ Descargar</button>
                        <button class="btn btn-secondary" id="regenerateContentBtn">üîÑ Regenerar</button>
                    </div>
                </div>

                <div id="avatarResults" class="avatar-results hidden">
                    <h2>üß† Avatar Ultra-Espec√≠fico</h2>
                    <div id="avatarDisplay" class="avatar-display">
                        <!-- Avatar completo se muestra aqu√≠ -->
                    </div>
                    
                    <div class="avatar-actions">
                        <button class="btn btn-secondary" id="copyAvatarBtn">üìã Copiar Avatar</button>
                        <button class="btn btn-secondary" id="downloadAvatarBtn">üìÑ Descargar</button>
                        <button class="btn btn-secondary" id="exportPersonasBtn">üë• Exportar Personas</button>
                    </div>
                </div>
                

                    <!-- ===== BUSCAR EN TU index.html DESPU√âS de los resultados de avatares m√∫ltiples ===== -->
                    <!-- ===== Y AGREGAR EXACTAMENTE ESTAS 5 L√çNEAS ===== -->

                    <!-- L√çNEA 1: El bot√≥n -->
                    <button onclick="exportToFunnelArchitect()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #1a202c; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 700; cursor: pointer; margin: 20px auto; display: flex; align-items: center; gap: 10px; box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);">üèóÔ∏è Crear Funnels con estos datos</button>

                    <!-- L√çNEAS 2-5: El script -->
                    <script>
                   // FUNCI√ìN EXPORTACI√ìN MEJORADA - Captura TODO el contexto
            function exportToFunnelArchitect() {
                console.log('üöÄ Iniciando exportaci√≥n con contexto completo...');
                
                // 1. DATOS B√ÅSICOS DEL AN√ÅLISIS PRINCIPAL
                const contextoCompleto = {
                    // Datos b√°sicos del nicho
                    nicho: document.getElementById('nicho')?.value?.trim() || '',
                    publico: document.getElementById('publico')?.value?.trim() || '',
                    keywords: document.getElementById('keywords')?.value?.trim() || '',
                    
                    // Configuraci√≥n del producto/mercado
                    rangoPrecios: document.getElementById('rangoPrecios')?.value || 'medio',
                    tipoProducto: document.getElementById('tipoProducto')?.value || 'digital',
                    canalPrincipal: document.getElementById('canalPrincipal')?.value || 'paid',
                    experiencia: document.getElementById('experiencia')?.value || 'intermedio',
                    
                    // Configuraci√≥n experta de afiliado
                    presupuestoAds: document.getElementById('presupuestoAds')?.value || '1000',
                    roiObjetivo: document.getElementById('roiObjetivo')?.value || '3',
                    breakEvenTime: document.getElementById('breakEvenTime')?.value || 'mes',
                    tipoConversion: document.getElementById('tipoConversion')?.value || 'inmediata',
                    dispositivoTarget: document.getElementById('dispositivoTarget')?.value || 'mobile',
                    mercadoGeo: document.getElementById('mercadoGeo')?.value || 'latam',
                    
                    // Configuraci√≥n de contenido viral (si existe)
                    salesAngle: document.getElementById('salesAngle')?.value || 'problema-agitacion',
                    controversyLevel: document.getElementById('controversyLevel')?.value || 'medium',
                    powerWords: document.getElementById('powerWords')?.value || '',
                    
                    // Configuraci√≥n de avatar (si existe)
                    avatarGender: document.getElementById('avatarGender')?.value || '',
                    avatarAge: document.getElementById('avatarAge')?.value || '',
                    avatarIncome: document.getElementById('avatarIncome')?.value || '',
                    avatarFamily: document.getElementById('avatarFamily')?.value || '',
                    avatarMainProblem: document.getElementById('avatarMainProblem')?.value || '',
                    avatarMainDesire: document.getElementById('avatarMainDesire')?.value || '',
                    
                    // Timestamp de la exportaci√≥n
                    fechaExportacion: new Date().toISOString(),
                    version: 'v1.2-contexto-completo'
                };
                
                // 2. AN√ÅLISIS SELECCIONADOS (todos los checkboxes)
                const analisisActivos = {
                    // An√°lisis b√°sicos
                    analyzeCompetition: document.getElementById('analyzeCompetition')?.checked || false,
                    analyzeTrends: document.getElementById('analyzeTrends')?.checked || false,
                    findAffiliates: document.getElementById('findAffiliates')?.checked || false,
                    analyzeKeywords: document.getElementById('analyzeKeywords')?.checked || false,
                    analyzeSeasonality: document.getElementById('analyzeSeasonality')?.checked || false,
                    analyzeProfitability: document.getElementById('analyzeProfitability')?.checked || false,
                    
                    // An√°lisis expertos
                    analyzeConversion: document.getElementById('analyzeConversion')?.checked || false,
                    analyzeFinancial: document.getElementById('analyzeFinancial')?.checked || false,
                    analyzeCompetitorIntel: document.getElementById('analyzeCompetitorIntel')?.checked || false,
                    analyzeCustomerJourney: document.getElementById('analyzeCustomerJourney')?.checked || false,
                    analyzeTrafficChannels: document.getElementById('analyzeTrafficChannels')?.checked || false,
                    analyzeFunnels: document.getElementById('analyzeFunnels')?.checked || false
                };
                
                // 3. AVATARES (mejorado)
                const avatarsAutomaticos = window.processedAvatars || [];
                const avatarUltraEspecifico = window.lastAvatarGenerated ? [{
                    titulo: "Avatar Ultra-Espec√≠fico Personalizado",
                    contenido: window.lastAvatarGenerated,
                    tipo: "ultra-especifico",
                    personalizado: true,
                    configuracion: {
                        gender: contextoCompleto.avatarGender,
                        age: contextoCompleto.avatarAge,
                        income: contextoCompleto.avatarIncome,
                        family: contextoCompleto.avatarFamily,
                        mainProblem: contextoCompleto.avatarMainProblem,
                        mainDesire: contextoCompleto.avatarMainDesire
                    }
                }] : [];
                
                const todosLosAvatares = [
                    ...avatarUltraEspecifico, // Primero el personalizado
                    ...avatarsAutomaticos     // Luego los autom√°ticos
                ];
                
                // 4. PRODUCTOS ANALIZADOS (mejorado)
                const productos = (AppState.productosDetectados || []).map(producto => ({
                    ...producto,
                    contextoAnalisis: {
                        nicho: contextoCompleto.nicho,
                        rangoPrecios: contextoCompleto.rangoPrecios,
                        tipoProducto: contextoCompleto.tipoProducto,
                        analisisUsados: analisisActivos
                    }
                }));
                
                // 5. CONTENIDO VIRAL GENERADO (si existe)
                const contenidoViral = {
                    ultimoGenerado: window.lastContentGenerated || null,
                    tiposSeleccionados: window.selectedContentTypes ? Array.from(window.selectedContentTypes) : [],
                    configuracion: {
                        salesAngle: contextoCompleto.salesAngle,
                        controversyLevel: contextoCompleto.controversyLevel,
                        powerWords: contextoCompleto.powerWords
                    }
                };
                
                // 6. VALIDACIONES PRE-EXPORTACI√ìN
                const validaciones = {
                    tieneAvatares: todosLosAvatares.length > 0,
                    tieneProductos: productos.length > 0,
                    tieneContextoBasico: !!(contextoCompleto.nicho && contextoCompleto.publico),
                    tieneConfiguracionExperta: !!(contextoCompleto.presupuestoAds && contextoCompleto.roiObjetivo)
                };
                
                // 7. PREPARAR DATOS PARA EXPORTACI√ìN
                const datosExportacion = {
                    contexto: contextoCompleto,
                    analisis: analisisActivos,
                    avatares: todosLosAvatares,
                    productos: productos,
                    contenidoViral: contenidoViral,
                    validaciones: validaciones,
                    metadatos: {
                        totalAvatares: todosLosAvatares.length,
                        totalProductos: productos.length,
                        tieneUltraEspecifico: avatarUltraEspecifico.length > 0,
                        completitud: calcularCompletitud(validaciones),
                        timestamp: Date.now()
                    }
                };
                
                // 8. EXPORTAR A LOCALSTORAGE
                try {
                    // Exportaci√≥n por categor√≠as (mantiene compatibilidad)
                    localStorage.setItem('funnel_avatars', JSON.stringify(todosLosAvatares));
                    localStorage.setItem('funnel_products', JSON.stringify(productos));
                    
                    // Nueva exportaci√≥n de contexto completo
                    localStorage.setItem('funnel_context_complete', JSON.stringify(contextoCompleto));
                    localStorage.setItem('funnel_analysis_config', JSON.stringify(analisisActivos));
                    localStorage.setItem('funnel_content_viral', JSON.stringify(contenidoViral));
                    
                    // Datos consolidados para el nuevo sistema
                    localStorage.setItem('marketinsight_export_v2', JSON.stringify(datosExportacion));
                    
                    console.log('‚úÖ Exportaci√≥n completa realizada:', datosExportacion.metadatos);
                    
                    // 9. FEEDBACK AL USUARIO
                    const { totalAvatares, totalProductos, tieneUltraEspecifico, completitud } = datosExportacion.metadatos;
                    
                    if (typeof Utils !== 'undefined' && Utils.showStatus) {
                        const completitudTexto = completitud >= 80 ? 'Contexto Completo' : 
                                            completitud >= 60 ? 'Contexto Bueno' : 
                                            'Contexto B√°sico';
                        
                        Utils.showStatus(
                            `‚úÖ Exportado: ${totalAvatares} avatares${tieneUltraEspecifico ? ' (incluye ultra-espec√≠fico)' : ''} + ${totalProductos} productos + ${completitudTexto} (${completitud}%)`, 
                            'success'
                        );
                    }
                    
                    // 10. ABRIR FUNNEL ARCHITECT
                    window.open('funnel-architect-standalone.html', '_blank');
                    
                } catch (error) {
                    console.error('‚ùå Error en exportaci√≥n:', error);
                    if (typeof Utils !== 'undefined' && Utils.showStatus) {
                        Utils.showStatus('‚ùå Error al exportar datos. Int√©ntalo de nuevo.', 'error');
                    } else {
                        alert('Error al exportar datos. Int√©ntalo de nuevo.');
                    }
                }
            }

            // FUNCI√ìN AUXILIAR: Calcular completitud del contexto
            function calcularCompletitud(validaciones) {
                const checks = [
                    validaciones.tieneAvatares,
                    validaciones.tieneProductos,
                    validaciones.tieneContextoBasico,
                    validaciones.tieneConfiguracionExperta
                ];
                
                const completados = checks.filter(check => check).length;
                return Math.round((completados / checks.length) * 100);
            }

            // FUNCI√ìN AUXILIAR: Actualizar bot√≥n con informaci√≥n contextual
            function updateFunnelExportButton() {
                const btn = document.querySelector('[onclick="exportToFunnelArchitect()"]');
                if (!btn) return;
                
                const avatarsAutomaticos = window.processedAvatars?.length || 0;
                const tieneUltraEspecifico = window.lastAvatarGenerated ? 1 : 0;
                const totalAvatares = avatarsAutomaticos + tieneUltraEspecifico;
                const productos = (typeof AppState !== 'undefined' && AppState.productosDetectados) ? AppState.productosDetectados.length : 0;
                
                // Calcular completitud b√°sica
                const tieneNicho = document.getElementById('nicho')?.value?.trim();
                const tienePublico = document.getElementById('publico')?.value?.trim();
                const tieneConfiguracion = !!(tieneNicho && tienePublico);
                
                if (totalAvatares === 0 && productos === 0) {
                    btn.innerHTML = 'üèóÔ∏è Crear Funnels (Genera avatares y productos primero)';
                    btn.style.opacity = '0.6';
                    btn.disabled = true;
                } else if (!tieneConfiguracion) {
                    btn.innerHTML = 'üèóÔ∏è Crear Funnels (Completa nicho y p√∫blico primero)';
                    btn.style.opacity = '0.7';
                    btn.disabled = false;
                } else {
                    const contextStatus = tieneConfiguracion ? '+ Contexto Completo' : '+ Contexto B√°sico';
                    btn.innerHTML = `üèóÔ∏è Crear Funnels (${totalAvatares} avatares + ${productos} productos ${contextStatus})`;
                    btn.style.opacity = '1';
                    btn.disabled = false;
                }
            }

            // AUTO-ACTUALIZAR EL BOT√ìN cuando cambien los datos
            document.addEventListener('DOMContentLoaded', function() {
                // Actualizar cuando cambien los campos principales
                ['nicho', 'publico', 'rangoPrecios', 'presupuestoAds'].forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.addEventListener('change', updateFunnelExportButton);
                        field.addEventListener('input', updateFunnelExportButton);
                    }
                });
                
                // Actualizar inicialmente
                setTimeout(updateFunnelExportButton, 1000);
            });
                    </script>

                


                    <!-- Estimaciones en tiempo real -->
                    <div id="quickEstimations" class="quick-estimations hidden"></div>
                </div>

                <div class="form-group">
                    <label>üìã Keywords o productos espec√≠ficos (opcional):</label>
                    <textarea id="keywords" rows="3" placeholder="Ej: prote√≠na whey, curso de yoga, smartwatch fitness..."></textarea>
                </div>

                <!-- NUEVA SECCI√ìN: CONFIGURACI√ìN AVANZADA (TEMPORALMENTE OCULTA) -->
                <div class="advanced-config-section" style="display: none;">
                    <div class="section-header">
                        <h4>‚öôÔ∏è Configuraci√≥n Avanzada</h4>
                        <span class="section-badge">PROFESIONAL</span>
                    </div>
                    
                    <div class="advanced-controls">
                        <!-- Control de Cantidad de Productos -->
                        <div class="control-group">
                            <label class="control-label">
                                <span class="label-icon">üî¢</span>
                                <span class="label-text">Productos a Generar</span>
                                <span class="label-value" id="productCountValue">3</span>
                            </label>
                            <div class="slider-container">
                                <input type="range" id="productCountSlider" min="3" max="10" value="3" class="professional-slider">
                                <div class="slider-labels">
                                    <span>3</span>
                                    <span>5</span>
                                    <span>7</span>
                                    <span>10</span>
                                </div>
                            </div>
                        </div>

                        <!-- Filtro por Score M√≠nimo -->
                        <div class="control-group">
                            <label class="control-label">
                                <span class="label-icon">üìä</span>
                                <span class="label-text">Score M√≠nimo</span>
                                <span class="label-value" id="minScoreValue">70</span>
                            </label>
                            <div class="slider-container">
                                <input type="range" id="minScoreSlider" min="60" max="95" value="70" step="5" class="professional-slider">
                                <div class="slider-labels">
                                    <span>60</span>
                                    <span>75</span>
                                    <span>85</span>
                                    <span>95</span>
                                </div>
                            </div>
                        </div>

                        <!-- Filtro por Nivel de Competencia -->
                        <div class="control-group">
                            <label class="control-label">
                                <span class="label-icon">üéØ</span>
                                <span class="label-text">Competencia M√°xima</span>
                            </label>
                            <div class="competition-filter">
                                <div class="filter-option active" data-level="BAJO">
                                    <span class="option-indicator"></span>
                                    <span class="option-text">Baja</span>
                                </div>
                                <div class="filter-option active" data-level="MEDIO">
                                    <span class="option-indicator"></span>
                                    <span class="option-text">Media</span>
                                </div>
                                <div class="filter-option active" data-level="ALTO">
                                    <span class="option-indicator"></span>
                                    <span class="option-text">Alta</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" id="generateBtn">
                    <span class="btn-icon">üöÄ</span>
                    <span class="btn-text">Detectar Productos Ganadores</span>
                </button>
            </div>

            <!-- Debug Section -->
            <div id="debugSection" class="debug-section hidden">
                <h3>üîß Informaci√≥n de Debug</h3>
                <div class="debug-content">
                    <div class="debug-item">
                        <strong>Estado API:</strong> <span id="debugApiStatus">No probada</span>
                    </div>
                    <div class="debug-item">
                        <strong>Productos extra√≠dos:</strong> <span id="debugProductCount">0</span>
                    </div>
                    <div class="debug-item">
                        <strong>√öltima respuesta:</strong>
                        <pre id="debugResponse">Sin respuesta a√∫n</pre>
                    </div>
                </div>
            </div>

            <!-- Loading -->
            <div id="loading" class="loading hidden">
                <div class="loading-content">
                    <div class="spinner"></div>
                    <h3>üîç Analizando el mercado con IA...</h3>
                    <p>Detectando productos ganadores y oportunidades de afiliaci√≥n</p>
                    <div class="loading-steps">
                        <div class="step active" id="step1">üß† Procesando an√°lisis psicol√≥gico...</div>
                        <div class="step" id="step2">üìä Calculando m√©tricas financieras...</div>
                        <div class="step" id="step3">üîç Evaluando competencia...</div>
                        <div class="step" id="step4">‚ú® Generando recomendaciones...</div>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div id="resultados" class="results hidden">
                <div class="results-header">
                    <h2>üí∞ Productos Ganadores Detectados</h2>
                    <div id="metricsOverview" class="metrics-overview hidden"></div>
                </div>
                
                <div class="results-content">
                    <div id="listaProductos"></div>
                    
                    <!-- Secci√≥n de insights adicionales -->
                    <div id="additionalInsights" class="additional-insights hidden">
                        <h3>üéØ Insights Adicionales del Mercado</h3>
                        <div id="nicheAnalysis" class="insight-section hidden"></div>
                        <div id="ecosystemAnalysis" class="insight-section hidden"></div>
                    </div>
                </div>
                
                <div class="export-section">
                    <h4>üì§ Exportar Resultados</h4>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" id="copyBtn">
                            <span class="btn-icon">üìã</span>
                            Copiar
                        </button>
                        <button class="btn btn-secondary" id="downloadBtn">
                            <span class="btn-icon">üìÑ</span>
                            Descargar TXT
                        </button>
                        <button class="btn btn-secondary" id="downloadExcelBtn">
                            <span class="btn-icon">üìä</span>
                            Exportar CSV
                        </button>
                        <button class="btn btn-secondary" id="toggleDebugBtn">
                            <span class="btn-icon">üîß</span>
                            Debug
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
   <!-- PROFIT CALCULATOR MODAL CORREGIDO - Agregar antes del cierre de </body> en index.html -->
<div id="profitCalculatorModal" class="modal-overlay hidden">
    <div class="modal-container profit-calculator-modal">
        <div class="modal-header">
            <h2>üí∞ Calculadora de Profit Inteligente</h2>
            <button class="modal-close" onclick="ProfitCalculator.closeModal()">√ó</button>
        </div>
        
        <div class="modal-body">
            <!-- Informaci√≥n del Producto -->
            <div class="product-info-calc">
                <h3 id="calcProductName">Producto</h3>
                <div class="product-stats-grid">
                    <div class="stat-box">
                        <span class="stat-label">Precio</span>
                        <span class="stat-value" id="calcProductPrice">$0</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">Comisi√≥n</span>
                        <span class="stat-value" id="calcProductCommission">0%</span>
                    </div>
                </div>
            </div>
            
            <!-- Inputs de Configuraci√≥n -->
            <div class="calculator-config">
                <h4>‚öôÔ∏è Configuraci√≥n de Campa√±a</h4>
                <div class="calc-inputs-grid">
                    <div class="calc-input-group">
                        <label>üíµ Presupuesto Diario</label>
                        <input type="number" id="calcBudget" value="50" min="10" max="10000">
                        <small>USD por d√≠a</small>
                    </div>
                    
                    <div class="calc-input-group">
                        <label>üéØ Canal Principal</label>
                        <select id="calcChannel">
                            <option value="facebook">Facebook Ads</option>
                            <option value="google">Google Ads</option>
                            <option value="tiktok">TikTok Ads</option>
                            <option value="native">Native Ads</option>
                        </select>
                    </div>
                    
                    <div class="calc-input-group">
                        <label>üìÖ D√≠as de Campa√±a</label>
                        <input type="number" id="calcDays" value="30" min="7" max="365">
                        <small>Duraci√≥n total</small>
                    </div>
                    
                    <div class="calc-input-group">
                        <label>üåç Mercado</label>
                        <select id="calcMarket">
                            <option value="tier1">Tier 1 (US/UK/CA)</option>
                            <option value="tier2">Tier 2 (EU/AU)</option>
                            <option value="tier3">Tier 3 (LATAM/ASIA)</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn btn-calculate" onclick="ProfitCalculator.calculate()">
                    <span>üßÆ</span>
                    <span>Calcular Escenarios</span>
                </button>
            </div>
            
            <!-- Resultados -->
            <div id="calculatorResults" class="calculator-results hidden">
                <h4>üìä Proyecci√≥n de Resultados</h4>
                
                <!-- Escenarios -->
                <div class="scenarios-grid">
                    <!-- Conservador -->
                    <div class="scenario-card conservative">
                        <h5>üò∞ Escenario Conservador</h5>
                        <div class="scenario-metrics">
                            <div class="metric-row">
                                <span>CPC:</span>
                                <span id="cpcConservative">$0</span>
                            </div>
                            <div class="metric-row">
                                <span>CTR:</span>
                                <span id="ctrConservative">0%</span>
                            </div>
                            <div class="metric-row">
                                <span>CR:</span>
                                <span id="crConservative">0%</span>
                            </div>
                            <div class="metric-row highlight">
                                <span>Profit:</span>
                                <span id="profitConservative">$0</span>
                            </div>
                            <div class="metric-row">
                                <span>ROI:</span>
                                <span id="roiConservative">0%</span>
                            </div>
                            <div class="metric-row">
                                <span>Breakeven:</span>
                                <span id="breakevenConservative">0 d√≠as</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Realista -->
                    <div class="scenario-card realistic">
                        <h5>üòä Escenario Realista</h5>
                        <div class="scenario-metrics">
                            <div class="metric-row">
                                <span>CPC:</span>
                                <span id="cpcRealistic">$0</span>
                            </div>
                            <div class="metric-row">
                                <span>CTR:</span>
                                <span id="ctrRealistic">0%</span>
                            </div>
                            <div class="metric-row">
                                <span>CR:</span>
                                <span id="crRealistic">0%</span>
                            </div>
                            <div class="metric-row highlight">
                                <span>Profit:</span>
                                <span id="profitRealistic">$0</span>
                            </div>
                            <div class="metric-row">
                                <span>ROI:</span>
                                <span id="roiRealistic">0%</span>
                            </div>
                            <div class="metric-row">
                                <span>Breakeven:</span>
                                <span id="breakevenRealistic">0 d√≠as</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Optimista -->
                    <div class="scenario-card optimistic">
                        <h5>üöÄ Escenario Optimista</h5>
                        <div class="scenario-metrics">
                            <div class="metric-row">
                                <span>CPC:</span>
                                <span id="cpcOptimistic">$0</span>
                            </div>
                            <div class="metric-row">
                                <span>CTR:</span>
                                <span id="ctrOptimistic">0%</span>
                            </div>
                            <div class="metric-row">
                                <span>CR:</span>
                                <span id="crOptimistic">0%</span>
                            </div>
                            <div class="metric-row highlight">
                                <span>Profit:</span>
                                <span id="profitOptimistic">$0</span>
                            </div>
                            <div class="metric-row">
                                <span>ROI:</span>
                                <span id="roiOptimistic">0%</span>
                            </div>
                            <div class="metric-row">
                                <span>Breakeven:</span>
                                <span id="breakevenOptimistic">0 d√≠as</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Proyecci√≥n de Escalamiento -->
                <div class="scaling-projection">
                    <h5>üìà Proyecci√≥n de Escalamiento</h5>
                    <div class="scaling-chart" id="scalingChart">
                        <!-- Gr√°fico simple sin librer√≠as -->
                    </div>
                    <div class="scaling-summary">
                        <div class="scaling-item">
                            <span>Mes 1:</span>
                            <span id="month1Profit">$0</span>
                        </div>
                        <div class="scaling-item">
                            <span>Mes 2:</span>
                            <span id="month2Profit">$0</span>
                        </div>
                        <div class="scaling-item">
                            <span>Mes 3:</span>
                            <span id="month3Profit">$0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Recomendaciones IA -->
                <div class="ai-recommendations">
                    <h5>ü§ñ Recomendaciones de IA</h5>
                    <div id="aiRecommendations" class="recommendations-content">
                        <!-- Recomendaciones din√°micas -->
                    </div>
                </div>
                
                <!-- Acciones -->
                <div class="calculator-actions">
                    <button class="btn btn-secondary" onclick="ProfitCalculator.exportReport()">
                        üìä Exportar Reporte
                    </button>
                    <button class="btn btn-secondary" onclick="ProfitCalculator.saveScenario()">
                        üíæ Guardar Escenario
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>
