<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèóÔ∏è Funnel Architect - MarketInsight Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: #e2e8f0;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(26, 32, 44, 0.6);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #f59e0b;
        }

        .header h1 {
            color: #f59e0b;
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #a0aec0;
            font-size: 1.1rem;
        }

        .status {
            background: rgba(26, 32, 44, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #22c55e;
        }

        .config-section {
            background: rgba(26, 32, 44, 0.6);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #4a5568;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .config-card {
            background: rgba(45, 55, 72, 0.7);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .config-card:hover {
            border-color: #f59e0b;
            transform: translateY(-2px);
        }

        .config-card h3 {
            color: #f59e0b;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #4a5568;
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: #e2e8f0;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        select:focus, textarea:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        .preview-box {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 15px;
            min-height: 80px;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-top: 10px;
        }

        .placeholder {
            color: #a0aec0;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #1a202c;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px auto;
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
        }

        .btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #2d3748;
            border-top: 4px solid #f59e0b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .results {
            display: none;
            background: rgba(26, 32, 44, 0.6);
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
            border: 2px solid #22c55e;
        }

        .results h3 {
            color: #22c55e;
            text-align: center;
            margin-bottom: 20px;
        }

        .funnel-content {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            border: 1px solid #4a5568;
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            padding: 10px 15px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            border: 1px solid #3b82f6;
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <a href="javascript:history.back()" class="back-link">‚Üê Volver a MarketInsight Pro</a>

    <div class="container">
        <div class="header">
            <h1>üèóÔ∏è Funnel Architect</h1>
            <p>Convierte tu an√°lisis en funnels de alta conversi√≥n</p>
        </div>

        <div class="status" id="dataStatus">
            <h3>üìä Estado de Datos Importados</h3>
            <div id="statusContent">
                <p>üîç Verificando datos importados...</p>
            </div>
        </div>

        <div class="config-section">
            <h2 style="color: #f59e0b; margin-bottom: 20px; text-align: center;">‚öôÔ∏è Configuraci√≥n del Funnel</h2>
            
            <div class="config-grid">
                <div class="config-card">
                    <h3>üß† Avatar Target</h3>
                    <div class="form-group">
                        <select id="avatarSelect">
                            <option value="">Cargando avatares...</option>
                        </select>
                        <div class="preview-box" id="avatarPreview">
                            <div class="placeholder">Selecciona un avatar para ver el preview</div>
                        </div>
                    </div>
                </div>

                <div class="config-card">
                    <h3>üí∞ Producto/Servicio</h3>
                    <div class="form-group">
                        <select id="productSelect">
                            <option value="">Cargando productos...</option>
                        </select>
                        <div class="preview-box" id="productPreview">
                            <div class="placeholder">Selecciona un producto para ver el preview</div>
                        </div>
                    </div>
                </div>

                <div class="config-card">
                    <h3>üèóÔ∏è Tipo de Funnel</h3>
                    <div class="form-group">
                        <select id="funnelType">
                            <option value="lead-generation">üéØ Lead Generation</option>
                            <option value="direct-sales">üí∞ Ventas Directas</option>
                            <option value="webinar-funnel">üé• Webinar Funnel</option>
                            <option value="membership-funnel">üë• Membership</option>
                            <option value="high-ticket">üíé High Ticket</option>
                        </select>
                    </div>
                </div>

                <div class="config-card">
                    <h3>üìä Presupuesto y Meta</h3>
                    <div class="form-group">
                        <label>üí∞ Presupuesto Mensual:</label>
                        <select id="budget">
                            <option value="1000">$1,000 - $3,000</option>
                            <option value="3000">$3,000 - $5,000</option>
                            <option value="5000">$5,000 - $10,000</option>
                            <option value="10000">$10,000+</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üéØ Objetivo:</label>
                        <select id="goal">
                            <option value="leads">1,000+ Leads</option>
                            <option value="sales-low">$5K-$15K Ventas</option>
                            <option value="sales-mid">$15K-$50K Ventas</option>
                            <option value="sales-high">$50K+ Ventas</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="config-card">
                <h3>‚öôÔ∏è Configuraci√≥n Avanzada</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>üìß Duraci√≥n Sequence:</label>
                        <select id="sequenceDuration">
                            <option value="7">7 d√≠as</option>
                            <option value="14" selected>14 d√≠as</option>
                            <option value="21">21 d√≠as</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üéØ Agresividad:</label>
                        <select id="aggressiveness">
                            <option value="soft">Suave</option>
                            <option value="medium" selected>Medio</option>
                            <option value="aggressive">Agresivo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üí° Estilo Copy:</label>
                        <select id="copyStyle">
                            <option value="storytelling">Storytelling</option>
                            <option value="emotional" selected>Emocional</option>
                            <option value="authority">Autoridad</option>
                        </select>
                    </div>
                </div>
            </div>

            <button class="btn" id="generateBtn" onclick="generateFunnel()">
                <span>üèóÔ∏è</span>
                <span>Construir Funnel Completo</span>
            </button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <h3>üèóÔ∏è Construyendo tu funnel...</h3>
            <p>Esto puede tomar 30-60 segundos</p>
        </div>

        <div class="results" id="results">
            <h3>üéØ Funnel Completo Generado</h3>
            <div class="funnel-content" id="funnelContent"></div>
            <div class="actions">
                <button class="btn btn-success" onclick="copyFunnel()">üìã Copiar Funnel</button>
                <button class="btn btn-secondary" onclick="downloadFunnel()">üíæ Descargar</button>
                <button class="btn btn-secondary" onclick="regenerateFunnel()">üîÑ Regenerar</button>
            </div>
        </div>
    </div>

    <script>
        // ESTADO GLOBAL ACTUALIZADO - Busca esta secci√≥n y reempl√°zala
        // ESTADO GLOBAL ACTUALIZADO - Busca esta secci√≥n y reempl√°zala
        let funnelData = {
            // Datos existentes (mantener)
            avatars: [],
            products: [],
            selectedAvatar: null,
            selectedProduct: null,
            generatedFunnel: null,
            
            // üÜï NUEVAS PROPIEDADES PARA CONTEXTO COMPLETO
            contexto: {}, // Contexto completo de MarketInsight Pro
            analisisConfig: {}, // Configuraci√≥n de an√°lisis seleccionados
            contenidoViral: {}, // Configuraci√≥n de contenido viral
            exportCompleto: {}, // Datos completos de la exportaci√≥n V2
            
            // üÜï METADATOS INTELIGENTES
            metadatos: {
                completitud: 0,
                tieneContextoCompleto: false,
                ultimaActualizacion: null,
                version: 'v2.0-inteligente'
            },
            
            // üÜï FUNCIONES DE UTILIDAD
            utils: {
                // Obtener avatar con contexto enriquecido
                getAvatarEnriquecido: function(avatarIndex) {
                    const avatar = funnelData.avatars[avatarIndex];
                    if (!avatar) return null;
                    
                    return {
                        ...avatar,
                        contextoInteligente: {
                            nicho: funnelData.contexto.nicho,
                            publico: funnelData.contexto.publico,
                            mercado: funnelData.contexto.mercadoGeo,
                            canal: funnelData.contexto.canalPrincipal,
                            presupuesto: funnelData.contexto.presupuestoAds,
                            problemaPrincipal: funnelData.contexto.avatarMainProblem,
                            deseoPrincipal: funnelData.contexto.avatarMainDesire,
                            demografia: {
                                edad: funnelData.contexto.avatarAge,
                                genero: funnelData.contexto.avatarGender,
                                ingresos: funnelData.contexto.avatarIncome,
                                familia: funnelData.contexto.avatarFamily
                            }
                        }
                    };
                },
                
                // Obtener producto con contexto enriquecido
                getProductoEnriquecido: function(productoIndex) {
                    const producto = funnelData.products[productoIndex];
                    if (!producto) return null;
                    
                    return {
                        ...producto,
                        contextoInteligente: {
                            rangoPrecios: funnelData.contexto.rangoPrecios,
                            tipoProducto: funnelData.contexto.tipoProducto,
                            canalOptimo: funnelData.contexto.canalPrincipal,
                            presupuestoValidado: funnelData.contexto.presupuestoAds,
                            roiObjetivo: funnelData.contexto.roiObjetivo,
                            mercadoGeo: funnelData.contexto.mercadoGeo,
                            analisisRealizados: funnelData.analisisConfig
                        }
                    };
                },
                
                // Validar congruencia avatar-producto
                validarCongruencia: function(avatarIndex, productoIndex) {
                    const avatar = this.getAvatarEnriquecido(avatarIndex);
                    const producto = this.getProductoEnriquecido(productoIndex);
                    
                    if (!avatar || !producto) return { score: 0, problemas: ['Avatar o producto no encontrado'] };
                    
                    const problemas = [];
                    let score = 100;
                    
                    // Validar precio vs poder adquisitivo
                    const precioProducto = parseInt(producto.precio?.replace(/[^0-9]/g, '') || '0');
                    const ingresos = avatar.contextoInteligente.demografia.ingresos;
                    
                    if (ingresos === 'bajo' && precioProducto > 50) {
                        problemas.push('Precio muy alto para ingresos bajos del avatar');
                        score -= 30;
                    }
                    
                    if (ingresos === 'alto' && precioProducto < 100) {
                        problemas.push('Precio puede ser muy bajo para avatar con ingresos altos');
                        score -= 10;
                    }
                    
                    // Validar canal vs demograf√≠a
                    const canal = avatar.contextoInteligente.canal;
                    const edad = avatar.contextoInteligente.demografia.edad;
                    
                    if (canal === 'tiktok' && edad === '45-55') {
                        problemas.push('TikTok puede no ser el mejor canal para avatar de 45-55 a√±os');
                        score -= 20;
                    }
                    
                    if (canal === 'email' && edad === '18-25') {
                        problemas.push('Email marketing puede ser menos efectivo para avatar de 18-25 a√±os');
                        score -= 15;
                    }
                    
                    // Validar problema-soluci√≥n fit
                    const problemaAvatar = avatar.contextoInteligente.problemaPrincipal?.toLowerCase() || '';
                    const solucionProducto = producto.descripcion?.toLowerCase() || '';
                    
                    if (problemaAvatar.includes('soledad') && solucionProducto.includes('productividad')) {
                        problemas.push('Problema del avatar (soledad) no coincide con soluci√≥n del producto (productividad)');
                        score -= 40;
                    }
                    
                    return {
                        score: Math.max(0, score),
                        problemas,
                        sugerencias: this.generarSugerencias(problemas)
                    };
                },
                
                // Generar sugerencias de mejora
                generarSugerencias: function(problemas) {
                    const sugerencias = [];
                    
                    problemas.forEach(problema => {
                        if (problema.includes('Precio muy alto')) {
                            sugerencias.push('Considera ofrecer plan de pagos o versi√≥n m√°s econ√≥mica');
                        }
                        if (problema.includes('canal')) {
                            sugerencias.push('Revisa la estrategia de canales o ajusta el targeting');
                        }
                        if (problema.includes('no coincide')) {
                            sugerencias.push('Ajusta el √°ngulo de venta o busca un producto m√°s alineado');
                        }
                    });
                    
                    return sugerencias;
                }
            }
        };

        // Cargar datos importados desde localStorage
        // FUNCI√ìN MEJORADA - Carga CONTEXTO COMPLETO de MarketInsight Pro
        function loadImportedData() {
            console.log('üîç Cargando datos importados con contexto completo...');
            
            try {
                // 1. CARGAR AVATARES (mantiene compatibilidad)
                const avatarsData = localStorage.getItem('funnel_avatars');
                if (avatarsData) {
                    funnelData.avatars = JSON.parse(avatarsData);
                    console.log('‚úÖ Avatares cargados:', funnelData.avatars.length);
                }

                // 2. CARGAR PRODUCTOS (mantiene compatibilidad)
                const productsData = localStorage.getItem('funnel_products');
                if (productsData) {
                    funnelData.products = JSON.parse(productsData);
                    console.log('‚úÖ Productos cargados:', funnelData.products.length);
                }

                // 3. üÜï CARGAR CONTEXTO COMPLETO (nueva funcionalidad)
                const contextoCompleto = localStorage.getItem('funnel_context_complete');
                if (contextoCompleto) {
                    funnelData.contexto = JSON.parse(contextoCompleto);
                    console.log('‚úÖ Contexto completo cargado:', funnelData.contexto);
                } else {
                    funnelData.contexto = {};
                    console.log('‚ö†Ô∏è No se encontr√≥ contexto completo, usando defaults');
                }

                // 4. üÜï CARGAR CONFIGURACI√ìN DE AN√ÅLISIS
                const analysisConfig = localStorage.getItem('funnel_analysis_config');
                if (analysisConfig) {
                    funnelData.analisisConfig = JSON.parse(analysisConfig);
                    console.log('‚úÖ Configuraci√≥n de an√°lisis cargada:', funnelData.analisisConfig);
                } else {
                    funnelData.analisisConfig = {};
                }

                // 5. üÜï CARGAR CONTENIDO VIRAL
                const contenidoViral = localStorage.getItem('funnel_content_viral');
                if (contenidoViral) {
                    funnelData.contenidoViral = JSON.parse(contenidoViral);
                    console.log('‚úÖ Configuraci√≥n de contenido viral cargada');
                } else {
                    funnelData.contenidoViral = {};
                }

                // 6. üÜï CARGAR EXPORTACI√ìN COMPLETA V2
                const exportCompleto = localStorage.getItem('marketinsight_export_v2');
                if (exportCompleto) {
                    funnelData.exportCompleto = JSON.parse(exportCompleto);
                    console.log('‚úÖ Exportaci√≥n completa V2 cargada:', funnelData.exportCompleto.metadatos);
                }

                // 7. FALLBACKS PARA COMPATIBILIDAD (buscar en ubicaciones alternativas)
                if (funnelData.avatars.length === 0) {
                    console.log('üîÑ Buscando avatares en ubicaciones alternativas...');
                    
                    // Opci√≥n 1: avatares m√∫ltiples
                    const multipleAvatars = localStorage.getItem('lastMultipleAvatars');
                    if (multipleAvatars) {
                        funnelData.avatars = parseAvatarsFromText(multipleAvatars);
                        console.log('‚úÖ Avatares m√∫ltiples encontrados:', funnelData.avatars.length);
                    }
                    
                    // Opci√≥n 2: avatar ultra-espec√≠fico
                    const ultraAvatar = localStorage.getItem('lastUltraSpecificAvatar');
                    if (ultraAvatar) {
                        funnelData.avatars.push({
                            titulo: "Avatar Ultra-Espec√≠fico",
                            contenido: ultraAvatar,
                            tipo: "ultra-especifico"
                        });
                        console.log('‚úÖ Avatar ultra-espec√≠fico encontrado');
                    }
                }

                // 8. BUSCAR PRODUCTOS EN UBICACIONES ADICIONALES
                if (funnelData.products.length === 0) {
                    console.log('üîÑ Buscando productos en ubicaciones alternativas...');
                    const backupProducts = localStorage.getItem('analysis_results');
                    if (backupProducts) {
                        const parsed = JSON.parse(backupProducts);
                        if (parsed.productos) {
                            funnelData.products = parsed.productos;
                            console.log('‚úÖ Productos backup encontrados:', funnelData.products.length);
                        }
                    }
                }

                // 9. ENRIQUECER DATOS CON CONTEXTO
                if (funnelData.contexto && Object.keys(funnelData.contexto).length > 0) {
                    // Enriquecer avatares con contexto
                    // Enriquecer avatares con contexto  
                    funnelData.avatars = funnelData.avatars.map(avatar => ({   // ‚úÖ CORRECTO: "avatars"
                        ...avatar,
                        contextoEnriquecido: {
                            nicho: funnelData.contexto.nicho,
                            publico: funnelData.contexto.publico,
                            demografiaTarget: {
                                edad: funnelData.contexto.avatarAge,
                                genero: funnelData.contexto.avatarGender,
                                ingresos: funnelData.contexto.avatarIncome,
                                familia: funnelData.contexto.avatarFamily
                            },
                            problemaPrincipal: funnelData.contexto.avatarMainProblem,
                            deseoPrincipal: funnelData.contexto.avatarMainDesire
                        }
                    }));

                    // Enriquecer productos con contexto
                    funnelData.products = funnelData.products.map(producto => ({
                        ...producto,
                        contextoEnriquecido: {
                            rangoPrecios: funnelData.contexto.rangoPrecios,
                            tipoProducto: funnelData.contexto.tipoProducto,
                            canalPrincipal: funnelData.contexto.canalPrincipal,
                            presupuesto: funnelData.contexto.presupuestoAds,
                            roiObjetivo: funnelData.contexto.roiObjetivo,
                            mercadoGeo: funnelData.contexto.mercadoGeo
                        }
                    }));

                    console.log('‚úÖ Datos enriquecidos con contexto completo');
                }

                // 10. ACTUALIZAR STATUS Y UI
                updateDataStatus();
                populateSelectors();

                // 11. MOSTRAR INFORMACI√ìN DE DEBUG EN CONSOLA
                console.log('üìä RESUMEN DE DATOS CARGADOS:');
                console.log('- Avatares:', funnelData.avatars.length);
                console.log('- Productos:', funnelData.products.length);
                console.log('- Contexto:', !!funnelData.contexto);
                console.log('- An√°lisis Config:', !!funnelData.analisisConfig);
                console.log('- Contenido Viral:', !!funnelData.contenidoViral);
                
                // 12. VALIDAR COMPLETITUD
                const completitud = calcularCompletitudFunnel();
                console.log('üìà Completitud de datos:', completitud + '%');
                
                if (completitud < 50) {
                    console.warn('‚ö†Ô∏è Completitud baja - algunos datos pueden estar faltando');
                }

            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                updateDataStatus(true);
            }
        }

        // FUNCI√ìN AUXILIAR: Calcular completitud espec√≠fica para funnels
        function calcularCompletitudFunnel() {
            const checks = {
                tieneAvatares: funnelData.avatars.length > 0,
                tieneProductos: funnelData.products.length > 0,
                tieneNicho: !!(funnelData.contexto?.nicho),
                tienePublico: !!(funnelData.contexto?.publico),
                tienePresupuesto: !!(funnelData.contexto?.presupuestoAds),
                tieneROI: !!(funnelData.contexto?.roiObjetivo),
                tieneCanal: !!(funnelData.contexto?.canalPrincipal),
                tieneConfigAvatar: !!(funnelData.contexto?.avatarMainProblem || funnelData.contexto?.avatarMainDesire)
            };
            
            const completados = Object.values(checks).filter(check => check).length;
            const total = Object.keys(checks).length;
            
            return Math.round((completados / total) * 100);
        }

        // FUNCI√ìN MEJORADA: Actualizar estado de datos con contexto
        function updateDataStatus(hasError = false) {
            const statusContent = document.getElementById('statusContent');
            
            if (hasError) {
                statusContent.innerHTML = '<p style="color: #ef4444;">‚ùå Error cargando datos. Regresa a MarketInsight Pro y exporta los datos nuevamente.</p>';
                return;
            }

            const avatarsCount = funnelData.avatars.length;
            const productsCount = funnelData.products.length;
            const tieneContexto = !!(funnelData.contexto && Object.keys(funnelData.contexto).length > 0);
            const completitud = calcularCompletitudFunnel();

            if (avatarsCount === 0 && productsCount === 0) {
                statusContent.innerHTML = `
                    <p style="color: #fbbf24;">‚ö†Ô∏è No se detectaron datos importados.</p>
                    <p>Regresa a MarketInsight Pro y usa el bot√≥n "üèóÔ∏è Crear Funnels" despu√©s de generar avatares y productos.</p>
                `;
            } else {
                const contextoTexto = tieneContexto ? 
                    `<p style="color: #22c55e;">üß† Contexto inteligente cargado (${completitud}% completitud)</p>` : 
                    `<p style="color: #fbbf24;">‚ö†Ô∏è Contexto b√°sico solamente</p>`;
                    
                statusContent.innerHTML = `
                    <p style="color: #22c55e;">‚úÖ Datos importados exitosamente</p>
                    <p>üìä ${avatarsCount} avatares disponibles</p>
                    <p>üí∞ ${productsCount} productos analizados</p>
                    ${contextoTexto}
                    ${tieneContexto ? `<p style="color: #90cdf4;">üìà Nicho: ${funnelData.contexto.nicho || 'No especificado'}</p>` : ''}
                    ${tieneContexto ? `<p style="color: #90cdf4;">üéØ P√∫blico: ${funnelData.contexto.publico || 'No especificado'}</p>` : ''}
                    ${tieneContexto ? `<p style="color: #90cdf4;">üí∞ Presupuesto: $${funnelData.contexto.presupuestoAds || 'No especificado'}+ mensual</p>` : ''}
                `;
            }
        }

    
        // Poblar selectores
        function populateSelectors() {
            const avatarSelect = document.getElementById('avatarSelect');
            const productSelect = document.getElementById('productSelect');

            // Limpiar selectores
            avatarSelect.innerHTML = '<option value="">Selecciona un avatar...</option>';
            productSelect.innerHTML = '<option value="">Selecciona un producto...</option>';

            // Poblar avatares
            funnelData.avatars.forEach((avatar, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = avatar.titulo || avatar.title || `Avatar ${index + 1}`;
                avatarSelect.appendChild(option);
            });

            // Poblar productos
            funnelData.products.forEach((product, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = product.nombre || product.name || `Producto ${index + 1}`;
                productSelect.appendChild(option);
            });

            console.log(`üìä Selectores poblados: ${funnelData.avatars.length} avatares, ${funnelData.products.length} productos`);
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Avatar selector
            document.getElementById('avatarSelect').addEventListener('change', function() {
                const index = this.value;
                if (index !== '') {
                    funnelData.selectedAvatar = funnelData.avatars[index];
                    const preview = document.getElementById('avatarPreview');
                    const avatar = funnelData.selectedAvatar;
                    const content = avatar.contenido || avatar.content || JSON.stringify(avatar, null, 2);
                    preview.innerHTML = `
                        <div style="color: #f59e0b; font-weight: 600; margin-bottom: 8px;">${avatar.titulo || avatar.title}</div>
                        <div style="color: #e2e8f0; font-size: 0.85rem; line-height: 1.4;">${content.substring(0, 200)}...</div>
                    `;
                } else {
                    funnelData.selectedAvatar = null;
                    document.getElementById('avatarPreview').innerHTML = '<div class="placeholder">Selecciona un avatar para ver el preview</div>';
                }
            });

            // Product selector
            document.getElementById('productSelect').addEventListener('change', function() {
                const index = this.value;
                if (index !== '') {
                    funnelData.selectedProduct = funnelData.products[index];
                    const preview = document.getElementById('productPreview');
                    const product = funnelData.selectedProduct;
                    preview.innerHTML = `
                        <div style="color: #22c55e; font-weight: 600; margin-bottom: 8px;">${product.nombre || product.name}</div>
                        <div style="color: #fbbf24; font-weight: 600; margin-bottom: 8px;">${product.precio || 'Precio no especificado'}</div>
                        <div style="color: #e2e8f0; font-size: 0.85rem; line-height: 1.4;">${(product.descripcion || product.description || '').substring(0, 150)}...</div>
                    `;
                } else {
                    funnelData.selectedProduct = null;
                    document.getElementById('productPreview').innerHTML = '<div class="placeholder">Selecciona un producto para ver el preview</div>';
                }
            });
        }

        // Generar funnel
        async function generateFunnel() {
            // Validaciones
            if (!funnelData.selectedAvatar) {
                alert('‚ö†Ô∏è Selecciona un avatar target');
                return;
            }

            if (!funnelData.selectedProduct) {
                alert('‚ö†Ô∏è Selecciona un producto');
                return;
            }

            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) {
                alert('‚ö†Ô∏è API Key no encontrada. Config√∫rala en MarketInsight Pro primero.');
                return;
            }

            // UI loading
            const generateBtn = document.getElementById('generateBtn');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');

            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span>üîÑ</span><span>Construyendo...</span>';
            loading.style.display = 'block';
            results.style.display = 'none';

            try {
                const prompt = buildFunnelPrompt();
                console.log('üöÄ Generando funnel...');

                const response = await callGeminiAPI(prompt, apiKey);
                
                funnelData.generatedFunnel = response;
                document.getElementById('funnelContent').textContent = response;
                
                loading.style.display = 'none';
                results.style.display = 'block';
                
                // Scroll to results
                results.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('‚ùå Error generando funnel:', error);
                alert(`Error generando funnel: ${error.message}`);
                loading.style.display = 'none';
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<span>üèóÔ∏è</span><span>Construir Funnel Completo</span>';
            }
        }

        // FUNCI√ìN ULTRA-INTELIGENTE - Construir prompt con contexto completo
        function buildFunnelPrompt() {
            const avatar = funnelData.selectedAvatar;
            const product = funnelData.selectedProduct;
            const funnelType = document.getElementById('funnelType').value;
            const budget = document.getElementById('budget').value;
            const goal = document.getElementById('goal').value;
            const sequenceDuration = document.getElementById('sequenceDuration').value;
            const aggressiveness = document.getElementById('aggressiveness').value;
            const copyStyle = document.getElementById('copyStyle').value;

            // EXTRAER CONTEXTO COMPLETO
            const contexto = funnelData.contexto || {};
            const analisisConfig = funnelData.analisisConfig || {};
            const contenidoViral = funnelData.contenidoViral || {};
            
            // PROCESAR AVATAR CON CONTEXTO ENRIQUECIDO
            const avatarContent = avatar.contenido || avatar.content || JSON.stringify(avatar, null, 2);
            const avatarContexto = avatar.contextoEnriquecido || {};
            
            // PROCESAR PRODUCTO CON CONTEXTO ENRIQUECIDO
            const productName = product.nombre || product.name || 'Producto';
            const productDesc = product.descripcion || product.description || '';
            const productPrice = product.precio || product.price || '';
            const productContexto = product.contextoEnriquecido || {};

            // MAPEAR CONFIGURACIONES TEXTUALES
            const rangoPrecios = {
                'bajo': '$10-$50 (Compra impulsiva, ingresos limitados)',
                'medio': '$50-$200 (Consideraci√≥n media, ingresos moderados)', 
                'alto': '$200-$500 (Decisi√≥n importante, ingresos buenos)',
                'muy-alto': '$500+ (Inversi√≥n significativa, ingresos altos)'
            }[contexto.rangoPrecios] || '$50-$200 (rango medio)';

            const presupuestoTexto = contexto.presupuestoAds ? 
                `$${contexto.presupuestoAds}+ mensual (configurado en MarketInsight Pro)` : 
                `$${budget}+ mensual`;

            const mercadoTexto = {
                'latam': 'Latinoam√©rica (espa√±ol, cultura latina, poder adquisitivo medio)',
                'usa': 'Estados Unidos (ingl√©s, alto poder adquisitivo)',
                'europa': 'Europa (multiidioma, regulaciones GDPR)',
                'global': 'Global (multicanal, multicultural)'
            }[contexto.mercadoGeo] || 'Mercado no especificado';

            // CONSTRUIR INFORMACI√ìN DE AN√ÅLISIS UTILIZADO
            const analisisUtilizados = [];
            if (analisisConfig.analyzeConversion) analisisUtilizados.push('M√©tricas de Conversi√≥n (CVR, EPC, AOV)');
            if (analisisConfig.analyzeFinancial) analisisUtilizados.push('An√°lisis Financiero (ROI, CPA, Profit)');
            if (analisisConfig.analyzeCompetition) analisisUtilizados.push('An√°lisis de Competencia');
            if (analisisConfig.analyzeTrends) analisisUtilizados.push('An√°lisis de Tendencias');
            if (analisisConfig.analyzeTrafficChannels) analisisUtilizados.push('Canales de Tr√°fico');
            if (analisisConfig.analyzeFunnels) analisisUtilizados.push('An√°lisis de Funnels');
            
            const analisisTexto = analisisUtilizados.length > 0 ? 
                `\nAN√ÅLISIS REALIZADOS: ${analisisUtilizados.join(', ')}` : '';

            // INFORMACI√ìN DEL CONTENIDO VIRAL (si existe)
            const contenidoViralInfo = contenidoViral.configuracion ? `
        CONFIGURACI√ìN VIRAL DETECTADA:
        - √Ångulo de venta preferido: ${contenidoViral.configuracion.salesAngle}
        - Nivel de controversia: ${contenidoViral.configuracion.controversyLevel}
        - Palabras de poder utilizadas: ${contenidoViral.configuracion.powerWords}
        - Tipos de contenido generados: ${contenidoViral.tiposSeleccionados?.join(', ') || 'No especificado'}` : '';

            // CONSTRUIR PROMPT ULTRA-INTELIGENTE
            return `Act√∫a como ARQUITECTO DE FUNNELS EXPERTO de √©lite con historial de $100M+ en ventas. Tu misi√≥n es crear un FUNNEL ULTRA-CONGRUENTE usando TODO el contexto analizado previamente.

        üéØ === CONTEXTO COMPLETO DE MARKETINSIGHT PRO ===

        NICHO ANALIZADO: "${contexto.nicho || 'No especificado'}"
        P√öBLICO TARGET: "${contexto.publico || 'No especificado'}"
        KEYWORDS INVESTIGADAS: "${contexto.keywords || 'No especificado'}"

        CONFIGURACI√ìN DE MERCADO:
        - Rango de precios: ${rangoPrecios}
        - Tipo de producto: ${contexto.tipoProducto || 'digital'}
        - Canal principal: ${contexto.canalPrincipal || 'paid ads'}
        - Experiencia afiliado: ${contexto.experiencia || 'intermedio'}
        - Presupuesto publicitario: ${presupuestoTexto}
        - ROI objetivo: ${contexto.roiObjetivo || '3'}x m√≠nimo
        - Break-even esperado: ${contexto.breakEvenTime || '1 mes'}
        - Tipo de conversi√≥n: ${contexto.tipoConversion || 'venta directa'}
        - Dispositivo principal: ${contexto.dispositivoTarget || 'mobile'}
        - Mercado geogr√°fico: ${mercadoTexto}${analisisTexto}

        === AVATAR ULTRA-ESPEC√çFICO ANALIZADO ===
        TIPO DE AVATAR: ${avatar.tipo === 'ultra-especifico' ? 'PERSONALIZADO ULTRA-ESPEC√çFICO' : 'AUTOM√ÅTICO EST√ÅNDAR'}

        ${avatar.tipo === 'ultra-especifico' && avatarContexto.demografiaTarget ? `
        DEMOGRAF√çA DETECTADA:
        - Edad: ${avatarContexto.demografiaTarget.edad}
        - G√©nero: ${avatarContexto.demografiaTarget.genero}  
        - Ingresos: ${avatarContexto.demografiaTarget.ingresos}
        - Situaci√≥n familiar: ${avatarContexto.demografiaTarget.familia}
        - Problema principal: ${avatarContexto.problemaPrincipal}
        - Deseo principal: ${avatarContexto.deseoPrincipal}
        ` : ''}

        CONTENIDO COMPLETO DEL AVATAR:
        ${avatarContent}

        === PRODUCTO ESPEC√çFICO ANALIZADO ===
        NOMBRE: ${productName}
        ${productPrice ? `PRECIO: ${productPrice}` : ''}
        ${productDesc ? `DESCRIPCI√ìN: ${productDesc}` : ''}

        ${productContexto.rangoPrecios ? `CONTEXTO DEL PRODUCTO:
        - Validado para rango: ${productContexto.rangoPrecios}
        - Canal principal efectivo: ${productContexto.canalPrincipal}
        - Presupuesto optimizado: $${productContexto.presupuesto}+
        - ROI target: ${productContexto.roiObjetivo}x
        - Mercado validado: ${productContexto.mercadoGeo}` : ''}

        ${product.painPoints ? `PAIN POINTS IDENTIFICADOS: ${product.painPoints}` : ''}
        ${product.emociones ? `EMOCIONES DETECTADAS: ${product.emociones}` : ''}
        ${product.triggers ? `TRIGGERS VALIDADOS: ${product.triggers}` : ''}
        ${product.cvrEstimado ? `CVR ESTIMADO: ${product.cvrEstimado}` : ''}
        ${product.epcEstimado ? `EPC ESTIMADO: ${product.epcEstimado}` : ''}

        === CONFIGURACI√ìN ESPEC√çFICA DEL FUNNEL ===
        - Tipo de funnel: ${funnelType}
        - Presupuesto mensual: ${budget}+ 
        - Objetivo: ${goal}
        - Duraci√≥n sequence: ${sequenceDuration} d√≠as
        - Agresividad: ${aggressiveness}
        - Estilo copy: ${copyStyle}${contenidoViralInfo}

        üéØ === REGLAS DE CONGRUENCIA ULTRA-ESPEC√çFICAS ===

        OBLIGATORIO - El funnel DEBE ser 100% congruente con:
        ‚úÖ El LENGUAJE exacto detectado en el avatar (formal/informal/t√©cnico/emocional)
        ‚úÖ Los PAIN POINTS espec√≠ficos identificados en el an√°lisis
        ‚úÖ Las EMOCIONES y TRIGGERS validados en el producto
        ‚úÖ El PODER ADQUISITIVO real del avatar (precios coherentes)
        ‚úÖ El CANAL de marketing configurado (copy apropiado para el canal)
        ‚úÖ El TIMING y URGENCIA adecuados al comportamiento detectado
        ‚úÖ La DEMOGRAF√çA espec√≠fica (edad, g√©nero, situaci√≥n familiar)
        ‚úÖ El MERCADO geogr√°fico (cultura, idioma, referencias locales)

        FORMATO OBLIGATORIO DE RESPUESTA:

        üéØ === AN√ÅLISIS DE CONGRUENCIA ULTRA-ESPEC√çFICO ===
        AVATAR_MATCH: [Por qu√© este producto es perfecto para ESTE avatar espec√≠fico]
        PAIN_POINTS_PRINCIPALES: [Los 3 dolores M√ÅS GRANDES de este avatar espec√≠fico]
        GATILLOS_EMOCIONALES: [Emociones exactas que activar basadas en el an√°lisis]
        OBJECIONES_PREVISTAS: [Las 3 objeciones principales y c√≥mo manejarlas]
        PRECIO_PSICOLOG√çA: [Por qu√© el precio es apropiado para ESTE avatar]
        CANAL_CONGRUENCIA: [Por qu√© ${contexto.canalPrincipal || 'este canal'} es perfecto para este avatar]
        MERCADO_CULTURAL: [Consideraciones espec√≠ficas para ${mercadoTexto}]

        üöÄ === FUNNEL OVERVIEW INTELIGENTE ===
        NOMBRE_FUNNEL: [Nombre que resuene espec√≠ficamente con este avatar]
        REVENUE_PROYECTADO: $[Cantidad mensual realista para ${contexto.mercadoGeo || 'este mercado'}]
        CVR_FUNNEL: [%] (Conversi√≥n total basada en el avatar espec√≠fico)
        AOV_ESTIMADO: $[Average Order Value para este poder adquisitivo]
        ROAS_ESPERADO: [X]x (Return on ad spend para ${contexto.canalPrincipal || 'este canal'})
        AUDIENCIA_SIZE: [Tama√±o de mercado espec√≠fico para este nicho + geograf√≠a]
        ESCALABILIDAD: [1-10] (Qu√© tan f√°cil es escalar con este avatar/producto)

        üíå === EMAIL SEQUENCE ${sequenceDuration} D√çAS ULTRA-ESPEC√çFICO ===
        ${Array.from({length: parseInt(sequenceDuration)}, (_, i) => {
            const day = i + 1;
            return `
        üìß EMAIL_${day}:
        SUBJECT: [Subject espec√≠fico para el avatar - usar su lenguaje exacto]
        PREVIEW: [Preview que active curiosidad espec√≠fica del dolor detectado]
        APERTURA: [Conectar con experiencia espec√≠fica del avatar]
        CUERPO: [Email 200-300 palabras con pain points ESPEC√çFICOS identificados]
        HISTORIA/CASO: [Ejemplo que resuene con la demograf√≠a exacta del avatar]
        CTA: [Llamada a acci√≥n en el lenguaje natural del avatar]
        TIMING_ENV√çO: [Mejor momento para ESTE avatar espec√≠fico]
        OPEN_RATE_EST: [%] | CLICK_RATE_EST: [%] (basado en demograf√≠a)
        `;
        }).join('')}

        üé® === LANDING PAGE ULTRA-ESPEC√çFICA ===
        HEADLINE: [Titular que pare el scroll de ESTE avatar espec√≠fico]
        SUBHEADLINE: [Agitar el dolor M√ÅS GRANDE identificado]
        HERO_COPY: [120-150 palabras ultra-espec√≠ficas para este avatar]
        BENEFICIOS_CORE: [3 beneficios que ESTE avatar valora M√ÅS]
        SOCIAL_PROOF: [Tipo espec√≠fico - casos de personas como este avatar]
        CTA_PRINCIPAL: [Texto del bot√≥n en el lenguaje exacto del avatar]
        OBJECIONES_MANEJO: [Manejar las 3 objeciones espec√≠ficas identificadas]
        URGENCIA_CULTURAL: [Crear urgencia apropiada para ${mercadoTexto}]
        MOBILE_OPTIMIZATION: [Espec√≠fica para ${contexto.dispositivoTarget || 'mobile'}]

        üí∞ === ESTRATEGIA FINANCIERA INTELIGENTE ===
        PRICING_STRATEGY: [Precios apropiados para ${rangoPrecios}]
        UPSELL_CONGRUENTE: [Producto que ESTE avatar REALMENTE comprar√°]
        PRECIO_UPSELL: $[Precio psicol√≥gicamente apropiado]
        TAKE_RATE_EST: [%] (Realista para esta demograf√≠a)
        DOWNSELL_INTELIGENTE: [Alternativa que mantenga valor pero sea accesible]
        PAYMENT_OPTIONS: [Opciones de pago apropiadas para ${mercadoTexto}]

        üìä === M√âTRICAS ULTRA-PRECISAS ===
        TRAFICO_NECESARIO: [Visitors mensuales para ${contexto.canalPrincipal || 'este canal'}]
        CPA_ESPEC√çFICO: $[Costo por adquisici√≥n realista para este avatar]
        LTV_CALCULADO: $[Lifetime value basado en comportamiento del avatar]
        PROFIT_MARGIN: [%] (Espec√≠fico para ${contexto.mercadoGeo || 'este mercado'})
        BREAK_EVEN: [D√≠as reales para ${contexto.breakEvenTime || 'este objetivo'}]

        üéØ === PLAN DE IMPLEMENTACI√ìN ===
        FASE_1_TESTING: [Plan espec√≠fico para validar con este avatar]
        FASE_2_SCALING: [C√≥mo escalar manteniendo congruencia]
        OPTIMIZACI√ìN_CONTINUA: [KPIs espec√≠ficos a monitorear]
        EXPANSI√ìN_INTELIGENTE: [C√≥mo expandir manteniendo avatar-producto fit]

        IMPORTANTE: 
        ‚ö° TODO debe ser ultra-espec√≠fico para ESTE avatar exacto
        ‚ö° USAR el lenguaje, referencias y cultura detectados
        ‚ö° PRECIOS coherentes con el poder adquisitivo real
        ‚ö° CANALES optimizados para la demograf√≠a espec√≠fica
        ‚ö° TIMING basado en comportamiento del avatar
        ‚ö° M√âTRICAS realistas para este mercado espec√≠fico

        OBJETIVO: Funnel que se sienta como si fuera creado por alguien que conoce √≠ntimamente a este avatar, su situaci√≥n, sus problemas y sus deseos m√°s profundos.`;
        }

        // Llamar a Gemini API
        async function callGeminiAPI(prompt, apiKey) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: prompt }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 8192,
                    }
                })
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            
            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                return data.candidates[0].content.parts[0].text;
            } else {
                throw new Error('Respuesta inv√°lida de la API');
            }
        }

        // Copiar funnel
        function copyFunnel() {
            if (funnelData.generatedFunnel) {
                navigator.clipboard.writeText(funnelData.generatedFunnel).then(() => {
                    alert('‚úÖ Funnel copiado al portapapeles');
                });
            }
        }

        // Descargar funnel
        function downloadFunnel() {
            if (funnelData.generatedFunnel) {
                const blob = new Blob([funnelData.generatedFunnel], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `funnel-${Date.now()}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        // Regenerar funnel
        function regenerateFunnel() {
            if (confirm('¬øRegenerar el funnel? Se perder√° la versi√≥n actual.')) {
                generateFunnel();
            }
        }

        // Parsear avatares desde texto (mejorado)
        function parseAvatarsFromText(text) {
            const avatars = [];
            
            // M√©todo 1: Avatares numerados (=== AVATAR 1: ===)
            const avatarMatches = text.match(/=== AVATAR \d+: ([^=]+) ===([\s\S]*?)(?==== AVATAR \d+:|$)/g);
            
            if (avatarMatches && avatarMatches.length > 0) {
                avatarMatches.forEach((match, index) => {
                    const titleMatch = match.match(/=== AVATAR \d+: ([^=]+) ===/);
                    const title = titleMatch ? titleMatch[1].trim() : `Avatar ${index + 1}`;
                    const content = match.replace(/=== AVATAR \d+: [^=]+ ===/, '').trim();
                    
                    avatars.push({
                        titulo: title,
                        contenido: content
                    });
                });
            }
            
            // M√©todo 2: Buscar nombres espec√≠ficos (LA PROFESIONAL OCUPADA, EL EMPRENDEDOR, etc.)
            const nameMatches = text.match(/(LA [A-Z\s]+ -|EL [A-Z\s]+ -|[A-Z\s]+ -)[^*]*/g);
            if (nameMatches && nameMatches.length > 0 && avatars.length === 0) {
                nameMatches.forEach((match, index) => {
                    const lines = match.split('\n');
                    const title = lines[0].replace(/^\*\*|\*\*$/g, '').trim();
                    const content = lines.slice(1).join('\n').trim();
                    
                    avatars.push({
                        titulo: title,
                        contenido: content
                    });
                });
            }
            
            // M√©todo 3: Si no hay formato espec√≠fico, dividir por p√°rrafos
            if (avatars.length === 0 && text.length > 100) {
                const paragraphs = text.split('\n\n').filter(p => p.trim().length > 50);
                if (paragraphs.length > 0) {
                    paragraphs.forEach((paragraph, index) => {
                        avatars.push({
                            titulo: `Avatar Detectado ${index + 1}`,
                            contenido: paragraph.trim()
                        });
                    });
                }
            }
            
            // M√©todo 4: Como √∫ltimo recurso, crear un avatar √∫nico
            if (avatars.length === 0) {
                avatars.push({
                    titulo: "Avatar Importado",
                    contenido: text
                });
            }
            
            return avatars;
        }

           
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando Funnel Architect con contexto inteligente...');
            
            // Peque√±o delay para asegurar que el DOM est√© completamente cargado
            setTimeout(function() {
                try {
                    // 1. Cargar datos importados
                    loadImportedData();
                    
                    // 2. Configurar event listeners
                    setupEventListeners();
                    
                    console.log('‚úÖ Funnel Architect inicializado correctamente');
                    
                } catch (error) {
                    console.error('‚ùå Error en inicializaci√≥n:', error);
                    
                    // Fallback: intentar carga manual
                    console.log('üîÑ Intentando carga manual de respaldo...');
                    
                    try {
                        // Cargar datos b√°sicos
                        const avatarsData = localStorage.getItem('funnel_avatars');
                        const productsData = localStorage.getItem('funnel_products');
                        
                        if (avatarsData) {
                            funnelData.avatars = JSON.parse(avatarsData);
                            console.log('‚úÖ Avatares cargados en fallback:', funnelData.avatars.length);
                        }
                        
                        if (productsData) {
                            funnelData.products = JSON.parse(productsData);
                            console.log('‚úÖ Productos cargados en fallback:', funnelData.products.length);
                        }
                        
                        // Poblar selectores manualmente
                        populateSelectors();
                        setupEventListeners();
                        updateDataStatus();
                        
                        console.log('‚úÖ Carga de respaldo completada');
                        
                    } catch (fallbackError) {
                        console.error('‚ùå Error en carga de respaldo:', fallbackError);
                    }
                }
            }, 500); // Delay de 500ms para asegurar carga completa
        });

        // Tambi√©n intentar cargar si ya est√° cargado el DOM
        if (document.readyState === 'loading') {
            // El DOM a√∫n se est√° cargando, usar el event listener de arriba
            console.log('üîÑ DOM carg√°ndose, esperando...');
        } else {
            // El DOM ya est√° cargado, ejecutar inmediatamente
            console.log('üîÑ DOM ya cargado, ejecutando inmediatamente...');
            setTimeout(function() {
                try {
                    loadImportedData();
                    setupEventListeners();
                    console.log('‚úÖ Inicializaci√≥n inmediata completada');
                } catch (error) {
                    console.error('‚ùå Error en inicializaci√≥n inmediata:', error);
                }
            }, 100);
        }

        // Backup: intentar cada 2 segundos hasta que funcione (m√°ximo 5 intentos)
        let intentos = 0;
        const maxIntentos = 5;
        
        const intervaloBusqueda = setInterval(function() {
            intentos++;
            
            // Si ya tenemos datos, parar el intervalo
            if (funnelData.avatars.length > 0 || funnelData.products.length > 0) {
                console.log('‚úÖ Datos encontrados, parando b√∫squeda autom√°tica');
                clearInterval(intervaloBusqueda);
                return;
            }
            
            // Si llegamos al m√°ximo de intentos, parar
            if (intentos >= maxIntentos) {
                console.log('‚ö†Ô∏è M√°ximo de intentos alcanzado, parando b√∫squeda autom√°tica');
                clearInterval(intervaloBusqueda);
                return;
            }
            
            console.log(`üîÑ Intento ${intentos}/${maxIntentos} de carga autom√°tica...`);
            
            try {
                loadImportedData();
                if (funnelData.avatars.length > 0 || funnelData.products.length > 0) {
                    populateSelectors();
                    setupEventListeners();
                    updateDataStatus();
                    console.log('‚úÖ Carga autom√°tica exitosa en intento', intentos);
                    clearInterval(intervaloBusqueda);
                }
            } catch (error) {
                console.log('‚ùå Intento', intentos, 'fall√≥:', error.message);
            }
        }, 2000); // Cada 2 segundos

        console.log('üèóÔ∏è Funnel Architect cargado - versi√≥n con contexto inteligente v2.0');
    </script>
</body>
</html>